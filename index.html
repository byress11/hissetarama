<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Destekli Borsa Analiz Platformu</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“Š</text></svg>">
  
  <!-- PWA Manifest ----
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQUkgRGVzdGVrbGkgQm9yc2EgQW5hbGl6IFBsYXRmb3JtdSIsInNob3J0X25hbWUiOiJCb3JzYSBBbmFsaXoiLCJkZXNjcmlwdGlvbiI6IldlYiBzY3JhcGluZyBpbGUgZ8O8w6dsZW5kaXJpbG1pxZ8gZ2Vyw6dlayB6YW1hbmzEsSB2ZXJpIGFuYWxpemkiLCJzdGFydF91cmwiOiIuLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwidGhlbWVfY29sb3IiOiIjNjY3ZWVhIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmOWZhZmIiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sLDxzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgMTAwIDEwMCc+PHRleHQgeT0nLjllbScgZm9udC1zaXplPSc5MCc+8J+TijwvdGV4dD48L3N2Zz4iLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9LHsic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sLDxzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgMTAwIDEwMCc+PHRleHQgeT0nLjllbScgZm9udC1zaXplPSc5MCc+8J+TijwvdGV4dD48L3N2Zz4iLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#667eea">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Borsa Analiz">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“Š</text></svg>">
  <style>
    /* Genel Stil AyarlarÄ± */
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f9fafb;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 1400px;
      margin: auto;
      padding: 20px;
    }
    /* BaÅŸlÄ±k */
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      text-align: center;
    }
    .header h1 {
      margin: 0;
      font-size: 2em;
    }
    /* Butonlar */
    .button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-right: 8px;
      font-size: 1em;
      transition: all 0.3s ease;
    }
    .button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .button.default {
      background-color: #4f46e5;
      color: white;
    }
    .button.outline {
      background-color: white;
      color: #4f46e5;
      border: 2px solid #4f46e5;
    }
    .button.success {
      background-color: #10b981;
      color: white;
    }
    .button.danger {
      background-color: #ef4444;
      color: white;
    }
    .button.warning {
      background-color: #f59e0b;
      color: white;
    }
    /* Input alanlarÄ± */
    .input-date {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 0.95em;
    }
    /* Kart gÃ¶rÃ¼nÃ¼mÃ¼ */
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 20px;
      overflow: hidden;
    }
    .card-header {
      background: #f3f4f6;
      padding: 15px 20px;
      border-bottom: 1px solid #e5e7eb;
      font-weight: 600;
    }
    .card-content {
      padding: 20px;
    }
    /* Grid Layout */
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
    /* Tablo */
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }
    th {
      background: #f9fafb;
      font-weight: 600;
      color: #374151;
    }
    tr:hover {
      background: #f9fafb;
    }
    /* UyarÄ± ve Bilgi */
    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    .alert.error {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }
    .alert.info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #bfdbfe;
    }
    .alert.success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }
    .alert.warning {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fcd34d;
    }
    /* AI Analiz BÃ¶lÃ¼mÃ¼ */
    .ai-section {
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }
    .ai-result {
      background: white;
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
      border: 1px solid #e5e7eb;
    }
    .ai-result h3 {
      margin-top: 0;
      color: #4f46e5;
    }
    .indicator-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    .badge-bullish {
      background: #d1fae5;
      color: #065f46;
    }
    .badge-bearish {
      background: #fee2e2;
      color: #b91c1c;
    }
    .badge-neutral {
      background: #e0e7ff;
      color: #3730a3;
    }
    /* YÃ¼kleme Animasyonu */
    .loader {
      border: 3px solid #f3f3f3;
      border-radius: 50%;
      border-top: 3px solid #4f46e5;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* Ä°statistik KartlarÄ± */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: white;
      padding: 16px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }
    .stat-label {
      font-size: 0.85em;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .stat-value {
      font-size: 1.5em;
      font-weight: 700;
      color: #111827;
    }
    /* Checkbox Grubu */
    .checkbox-group {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin: 16px 0;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    /* Grafik tÄ±klanabilir cursor */
    canvas {
      cursor: crosshair;
    }
    /* Grafik popup animasyonu */
    .chart-popup {
      animation: popupFadeIn 0.3s ease-out;
      backdrop-filter: blur(10px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.1);
    }
    @keyframes popupFadeIn {
      from {
        opacity: 0;
        transform: scale(0.8) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
    /* Veri KaynaÄŸÄ± SeÃ§imi */
    .data-source-config {
      background: #f0f9ff;
      border: 1px solid #0ea5e9;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .data-source-select {
      margin: 8px 0;
    }
    .data-source-select select {
      padding: 6px 12px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      background: white;
      width: 200px;
    }
    .api-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      margin: 8px 0;
    }
    /* Proxy UyarÄ±sÄ± */
    .proxy-warning {
      background: #fef3c7;
      border: 1px solid #fcd34d;
      border-radius: 8px;
      padding: 12px;
      margin: 12px 0;
      font-size: 0.9em;
    }
    /* Ã–rnek Veri KartlarÄ± */
    .example-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 12px;
      margin: 16px 0;
    }
    .example-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .example-card:hover {
      border-color: #4f46e5;
      box-shadow: 0 2px 8px rgba(79, 70, 229, 0.1);
    }
    .example-card.selected {
      border-color: #4f46e5;
      background: #f0f9ff;
    }
    .example-title {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 4px;
    }
    .example-desc {
      font-size: 0.85em;
      color: #6b7280;
    }
  </style>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <!-- Papa Parse (CSV) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <!-- SheetJS (Excel) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <div class="container">
    <!-- BaÅŸlÄ±k -->
    <div class="header">
      <h1>ğŸ¤– AI Destekli Borsa Analiz Platformu</h1>
      <p style="margin: 5px 0 0 0; opacity: 0.9;">Web scraping ile gÃ¼Ã§lendirilmiÅŸ gerÃ§ek zamanlÄ± veri analizi</p>
    </div>

    <!-- Veri YÃ¼kleme BÃ¶lÃ¼mÃ¼ -->
    <div class="grid">
      <!-- Dosya YÃ¼kleme -->
      <div class="card">
        <div class="card-header">ğŸ“ Dosya YÃ¼kleme</div>
        <div class="card-content">
          <input type="file" id="file-input" accept=".pdf,.csv,.xlsx,.xls" style="margin-bottom: 10px;">
          <div id="loading-text" style="display:none;" class="alert info">Dosya iÅŸleniyor...</div>
          <div id="error-alert" class="alert error" style="display:none;"></div>
          <div id="data-summary" class="alert success" style="display:none;">
            <strong>âœ“ Veri YÃ¼klendi</strong>
            <p id="record-count" style="margin: 5px 0;"></p>
            <p id="date-range" style="margin: 5px 0;"></p>
          </div>
        </div>
      </div>

      <!-- YapÄ±ÅŸtÄ±rarak Veri YÃ¼kleme -->
      <div class="card">
        <div class="card-header">ğŸ“‹ Veri YapÄ±ÅŸtÄ±rma</div>
        <div class="card-content">
          <textarea id="paste-input" rows="4" style="width:100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;" 
                    placeholder="Tarih Åimdi AÃ§Ä±lÄ±ÅŸ YÃ¼ksek DÃ¼ÅŸÃ¼k Hacim formatÄ±nda veri yapÄ±ÅŸtÄ±rÄ±n..."></textarea>
          <button id="btn-paste-process" class="button default" style="margin-top:10px;">Veriyi Ä°ÅŸle</button>
        </div>
      </div>
    </div>

    <!-- TÃ¼rk Hisse Senetleri Toplu Analiz BÃ¶lÃ¼mÃ¼ -->
    <div class="card">
      <div class="card-header">ğŸ‡¹ğŸ‡· TÃ¼rk Hisse Senetleri Toplu Analiz</div>
      <div class="card-content">
        <div style="margin-bottom: 16px;">
          <h4 style="margin-top: 0; color: #0369a1;">ğŸ“Š Fiyat Filtresi ile Hisse Analizi</h4>
          <p style="color: #6b7280; font-size: 0.9em;">BelirlediÄŸiniz tarih aralÄ±ÄŸÄ±nda aynÄ± fiyat deÄŸerine sahip veya tolerans aralÄ±ÄŸÄ±ndaki hisseleri bulun.</p>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin: 16px 0;">
            <div>
              <label style="display: block; font-size: 0.85em; color: #64748b; margin-bottom: 4px;">BaÅŸlangÄ±Ã§ Tarihi:</label>
              <input type="date" id="start-date" class="input-date" style="width: 100%;">
            </div>
            <div>
              <label style="display: block; font-size: 0.85em; color: #64748b; margin-bottom: 4px;">BitiÅŸ Tarihi:</label>
              <input type="date" id="end-date" class="input-date" style="width: 100%;">
            </div>
            <div>
              <label style="display: block; font-size: 0.85em; color: #64748b; margin-bottom: 4px;">Tolerans (%):</label>
              <input type="number" id="tolerance" value="10" min="0" max="50" step="1" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
            </div>
          </div>
          
          <div style="margin: 16px 0;">
            <button id="btn-analyze-stocks" class="button success">ğŸ” Hisseleri Analiz Et</button>
            <button id="btn-export-results" class="button outline" style="display: none;">ğŸ“Š SonuÃ§larÄ± DÄ±ÅŸa Aktar</button>
          </div>
          
          <div id="analysis-progress" style="display: none;">
            <div class="alert info">
              <div style="display: flex; align-items: center; gap: 10px;">
                <div class="loader" style="width: 20px; height: 20px; margin: 0;"></div>
                <span id="progress-text">Hisseler analiz ediliyor...</span>
              </div>
              <div style="margin-top: 8px;">
                <div style="background: #e5e7eb; border-radius: 4px; height: 8px;">
                  <div id="progress-bar" style="background: #10b981; height: 100%; border-radius: 4px; width: 0%; transition: width 0.3s ease;"></div>
                </div>
                <span id="progress-count" style="font-size: 0.8em; color: #6b7280;">0 / 0</span>
              </div>
            </div>
          </div>
          
          <div id="analysis-results" style="display: none;">
            <div class="alert success">
              <h4 style="margin-top: 0;">âœ… Analiz TamamlandÄ±</h4>
              <div id="results-summary"></div>
            </div>
            
            <div style="margin-top: 16px;">
              <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
                <button id="btn-sort-symbol" class="button outline" style="font-size: 0.85em;">Sembole GÃ¶re SÄ±rala</button>
                <button id="btn-sort-price" class="button outline" style="font-size: 0.85em;">Fiyata GÃ¶re SÄ±rala</button>
                <button id="btn-sort-change" class="button outline" style="font-size: 0.85em;">DeÄŸiÅŸime GÃ¶re SÄ±rala</button>
                <button id="btn-filter-matched" class="button outline" style="font-size: 0.85em;">Sadece EÅŸleÅŸenleri GÃ¶ster</button>
              </div>
              
              <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
                <table id="results-table" style="margin: 0;">
                  <thead>
                    <tr style="background: #f9fafb; position: sticky; top: 0;">
                      <th>Hisse</th>
                      <th>BaÅŸlangÄ±Ã§ FiyatÄ±</th>
                      <th>BitiÅŸ FiyatÄ±</th>
                      <th>DeÄŸiÅŸim (%)</th>
                      <th>Durum</th>
                      <th>Aksiyon</th>
                    </tr>
                  </thead>
                  <tbody id="results-tbody">
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Web Scraping Veri Ã‡ekme BÃ¶lÃ¼mÃ¼ -->
    <div class="card">
      <div class="card-header">ğŸŒ CanlÄ± Veri Ã‡ekme (Web Scraping)</div>
      <div class="card-content">
        <!-- Veri KaynaÄŸÄ± SeÃ§imi -->
        <div class="data-source-config">
          <h4 style="margin-top: 0; color: #0369a1;">âš™ï¸ Veri KaynaÄŸÄ± AyarlarÄ±</h4>
          <div class="data-source-select">
            <label for="data-source">Veri KaynaÄŸÄ±:</label>
            <select id="data-source" class="data-source-select">
              <option value="yahoo">Yahoo Finance (Global + BIST)</option>
              <option value="investing">Investing.com (TÃ¼rkÃ§e + Global)</option>
              <option value="tradingview">TradingView (Professional)</option>
              <option value="bigpara">BigPara (TÃ¼rkiye Focus)</option>
              <option value="demo">Demo Veri (Test AmaÃ§lÄ±)</option>
            </select>
          </div>
          
          <!-- CORS uyarÄ±sÄ± kaldÄ±rÄ±ldÄ± -->
        </div>



        <!-- Manuel Hisse GiriÅŸi -->
        <div style="margin-bottom: 16px;">
          <div style="display: flex; align-items: center; margin-bottom: 10px;">
            <label for="stock-symbol-input">Veya Manuel Hisse SembolÃ¼ Girin:</label>
            <div style="margin-left: 10px;">
              <input type="checkbox" id="auto-mode" checked>
              <label for="auto-mode">Otomatik Mod</label>
              <span class="tooltip" style="font-size: 0.8em; color: #6b7280;">(2 yÄ±llÄ±k gÃ¼nlÃ¼k veri + GeliÅŸmiÅŸ Analiz)</span>
            </div>
          </div>
          <div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
            <input type="text" id="stock-symbol-input" placeholder="Ã–rn: AAPL, THYAO, MSFT..." 
                   style="flex: 1; min-width: 200px; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
            <button id="btn-fetch-data" class="button success">ğŸ“ˆ Veri Ã‡ek</button>
          </div>
          
          <!-- GeliÅŸmiÅŸ Veri SeÃ§enekleri -->
          <div style="margin-top: 12px; padding: 12px; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">
            <h4 style="margin: 0 0 12px 0; color: #334155; font-size: 0.95em;">ğŸ“… Veri Parametreleri</h4>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px;">
              <!-- Zaman AralÄ±ÄŸÄ± -->
              <div>
                <label style="display: block; font-size: 0.85em; color: #64748b; margin-bottom: 4px;">Zaman AralÄ±ÄŸÄ±:</label>
                <select id="time-period-select" style="width: 100%; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;">
                  <option value="5d">Son 5 GÃ¼n</option>
                  <option value="1mo">Son 1 Ay</option>
                  <option value="3mo">Son 3 Ay</option>
                  <option value="6mo">Son 6 Ay</option>
                  <option value="1y">Son 1 YÄ±l</option>
                  <option value="2y" selected>Son 2 YÄ±l</option>
                  <option value="5y">Son 5 YÄ±l</option>
                  <option value="max">Maksimum</option>
                </select>
              </div>
              
              <!-- Veri SÄ±klÄ±ÄŸÄ± -->
              <div>
                <label style="display: block; font-size: 0.85em; color: #64748b; margin-bottom: 4px;">Veri SÄ±klÄ±ÄŸÄ±:</label>
                <select id="data-interval-select" style="width: 100%; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;">
                  <option value="1d" selected>GÃ¼nlÃ¼k</option>
                  <option value="1wk">HaftalÄ±k</option>
                  <option value="1mo">AylÄ±k</option>
                </select>
              </div>
              
              <!-- Veri Boyutu (Opsiyonel) -->
              <div>
                <label style="display: block; font-size: 0.85em; color: #64748b; margin-bottom: 4px;">KayÄ±t Limiti:</label>
                <select id="data-limit-select" style="width: 100%; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;">
                  <option value="auto" selected>Otomatik</option>
                  <option value="100">Son 100 KayÄ±t</option>
                  <option value="250">Son 250 KayÄ±t</option>
                  <option value="500">Son 500 KayÄ±t</option>
                  <option value="1000">Son 1000 KayÄ±t</option>
                </select>
              </div>
            </div>
            
            <!-- Bilgi KartlarÄ± -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; margin-top: 12px;">
              <div style="background: #e0f2fe; padding: 8px; border-radius: 4px; font-size: 0.8em;">
                <strong>â±ï¸ GÃ¼nlÃ¼k:</strong> DetaylÄ± intraday analiz iÃ§in ideal
              </div>
              <div style="background: #e8f5e8; padding: 8px; border-radius: 4px; font-size: 0.8em;">
                <strong>ğŸ“… HaftalÄ±k:</strong> Orta vadeli trend analizi
              </div>
              <div style="background: #fef3e2; padding: 8px; border-radius: 4px; font-size: 0.8em;">
                <strong>ğŸ“Š AylÄ±k:</strong> Uzun vadeli stratejik gÃ¶rÃ¼nÃ¼m
              </div>
            </div>
          </div>
          
          <small style="color: #6b7280; margin-top: 8px; display: block;">
            <strong>Desteklenen formatlar:</strong> AAPL, THYAO.IS, MSFT, BTC-USD, ^GSPC (S&P 500)
            <br><strong>Maksimum veri:</strong> Yahoo Finance ~20 yÄ±l, diÄŸer kaynaklar deÄŸiÅŸkenlik gÃ¶sterir
          </small>
        </div>

        <!-- YÃ¼kleme ve SonuÃ§lar -->
        <div id="fetch-loading" style="display:none;" class="alert info">
          <div class="loader" style="width: 20px; height: 20px; display: inline-block; margin-right: 8px;"></div>
          <span id="fetch-status">Veri Ã§ekiliyor...</span>
        </div>
        <div id="fetch-error" class="alert error" style="display:none;"></div>
        <div id="fetched-data-summary" style="display:none;" class="alert success">
          <strong>âœ“ Veriler BaÅŸarÄ±yla Getirildi</strong>
          <p id="fetched-record-count" style="margin: 5px 0;"></p>
          <p id="fetched-date-range" style="margin: 5px 0;"></p>
          <p id="fetched-source-info" style="margin: 5px 0; font-size: 0.9em; color: #6b7280;"></p>
          <button id="btn-use-fetched-data" class="button success" style="margin-top: 8px;">Bu Verileri Kullan</button>
        </div>
      </div>
    </div>

    <!-- Kontrol Paneli -->
    <div id="controls" class="card" style="display:none;">
      <div class="card-content">
        <!-- Sekme ButonlarÄ± -->
        <div style="margin-bottom: 16px;">
          <button id="btn-grafik" class="button default">ğŸ“Š Grafikler</button>
          <button id="btn-tablo" class="button outline">ğŸ“‹ Tablo</button>
          <button id="btn-ai-analiz" class="button success">ğŸ¤– GeliÅŸmiÅŸ AI Analiz</button>
          <button id="btn-export" class="button outline">ğŸ’¾ DÄ±ÅŸa Aktar</button>
        </div>

        <!-- Filtreler -->
        <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
          <label>BaÅŸlangÄ±Ã§:
            <input type="date" id="filter-start" class="input-date">
          </label>
          <label>BitiÅŸ:
            <input type="date" id="filter-end" class="input-date">
          </label>
          <button id="btn-reset-filters" class="button outline">ğŸ”„ SÄ±fÄ±rla</button>
        </div>

        <!-- Ä°ndikatÃ¶r SeÃ§imi -->
        <div class="checkbox-group" id="indicator-group" style="margin-top: 16px;">
          <div class="checkbox-item">
            <input type="checkbox" id="ind-sma" checked>
            <label for="ind-sma">SMA (20)</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="ind-ema">
            <label for="ind-ema">EMA (20)</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="ind-bollinger">
            <label for="ind-bollinger">Bollinger BantlarÄ±</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="ind-volume-avg">
            <label for="ind-volume-avg">Hacim OrtalamasÄ±</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="volume-line-chart">
            <label for="volume-line-chart">Hacim Ã‡izgi GrafiÄŸi</label>
          </div>
        </div>
      </div>
    </div>

    <!-- Ä°statistikler -->
    <div id="stats-container" class="stats-grid" style="display:none;"></div>

    <!-- Ana Ä°Ã§erik AlanÄ± -->
    <div id="content" class="card" style="display:none;">
      <div class="card-content" id="content-body">
        <div style="text-align:center; padding:40px; color: #6b7280;">
          LÃ¼tfen veri yÃ¼kleyin veya web'den Ã§ekin
        </div>
      </div>
    </div>

    <!-- AI Analiz SonuÃ§larÄ± -->
    <div id="ai-analysis" class="ai-section" style="display:none;">
      <h2 style="margin-top: 0;">ğŸ¤– Yapay Zeka Analizi</h2>
      <div id="ai-loading" class="loader" style="display:none;"></div>
      <div id="ai-results"></div>
    </div>
  </div>

  <script>
    // PDF.js worker
    if (window.pdfjsLib) {
      window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }

    // Global DeÄŸiÅŸkenler
    let stockData = [];
    let currentPage = 'grafik';
    let charts = {};
    let fetchedStockData = [];
    let selectedStockSymbol = '';

    // Veri kaynaklarÄ± konfigÃ¼rasyonu
    const DATA_SOURCES = {
      yahoo: {
        baseUrl: 'https://query1.finance.yahoo.com/v8/finance/chart/',
        name: 'Yahoo Finance',
        corsProxy: 'https://corsproxy.io/?',
      },
      investing: {
        name: 'Investing.com',
        corsProxy: 'https://api.allorigins.win/raw?url=',
        alternativeProxy: 'https://corsproxy.io/?',
        baseUrl: 'https://api.investing.com/'
      },
      tradingview: {
        name: 'TradingView',
        corsProxy: 'https://corsproxy.io/?',
        scannerUrl: 'https://scanner.tradingview.com/',
        symbolUrl: 'https://symbol-search.tradingview.com/symbol_search/?text='
      },
      bigpara: {
        name: 'BigPara',
        corsProxy: 'https://api.allorigins.win/raw?url=',
        baseUrl: 'https://www.bigpara.hurriyet.com.tr/api/v1/'
      },
      // Yeni alternatif kaynaklar
      twelvedata: {
        name: 'Twelve Data',
        corsProxy: 'https://corsproxy.io/?',
        baseUrl: 'https://api.twelvedata.com/time_series'
      },
      finnhub: {
        name: 'Finnhub',
        corsProxy: 'https://corsproxy.io/?',
        baseUrl: 'https://finnhub.io/api/v1/stock/candle'
      }
    };

    // CORS Proxy yÃ¶netimi iÃ§in yardÄ±mcÄ± fonksiyonlar
    const CORS_PROXIES = [
      'https://corsproxy.io/?',
      'https://api.allorigins.win/raw?url=',
      'https://cors-anywhere.herokuapp.com/',
      'https://thingproxy.freeboard.io/fetch/',
      'https://api.codetabs.com/v1/proxy?quest='
    ];

    async function fetchWithProxy(url, options = {}, retryCount = 0) {
      const proxy = CORS_PROXIES[retryCount % CORS_PROXIES.length];
      const fullUrl = proxy + encodeURIComponent(url);
      
      try {
        const response = await fetch(fullUrl, {
          ...options,
          headers: {
            'Accept': 'application/json',
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
            ...options.headers
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        return response;
      } catch (error) {
        if (retryCount < CORS_PROXIES.length - 1) {
          console.warn(`Proxy ${proxy} baÅŸarÄ±sÄ±z, alternatif deneniyor...`);
          return fetchWithProxy(url, options, retryCount + 1);
        }
        throw error;
      }
    }

    // Demo veri Ã¼retme fonksiyonu
    function generateDemoData(symbol, period, interval = '1d') {
      // KayÄ±t sayÄ±sÄ±nÄ± period ve interval'e gÃ¶re hesapla
      let records;
      let timeUnit = 'days';
      
      switch (period) {
        case '5d': records = interval === '1d' ? 5 : 1; break;
        case '1mo': 
          if (interval === '1d') records = 30;
          else if (interval === '1wk') records = 4;
          else records = 1;
          break;
        case '3mo':
          if (interval === '1d') records = 90;
          else if (interval === '1wk') records = 12;
          else records = 3;
          break;
        case '6mo':
          if (interval === '1d') records = 180;
          else if (interval === '1wk') records = 26;
          else records = 6;
          break;
        case '1y':
          if (interval === '1d') records = 365;
          else if (interval === '1wk') records = 52;
          else records = 12;
          break;
        case '2y':
          if (interval === '1d') records = 730;
          else if (interval === '1wk') records = 104;
          else records = 24;
          break;
        case '5y':
          if (interval === '1d') records = 1825;
          else if (interval === '1wk') records = 260;
          else records = 60;
          break;
        case 'max':
          if (interval === '1d') records = 3650; // 10 yÄ±l
          else if (interval === '1wk') records = 520;
          else records = 120;
          break;
        default: records = 90;
      }
      
      // Zaman aralÄ±ÄŸÄ±nÄ± interval'e gÃ¶re ayarla
      let timeIncrement;
      if (interval === '1d') {
        timeIncrement = 1; // gÃ¼nler
        timeUnit = 'days';
      } else if (interval === '1wk') {
        timeIncrement = 7; // haftalar
        timeUnit = 'days';
      } else { // 1mo
        timeIncrement = 30; // aylar (yaklaÅŸÄ±k)
        timeUnit = 'days';
      }
      
      const basePrice = getBasePriceForSymbol(symbol);
      const data = [];
      let currentPrice = basePrice;
      
      for (let i = records - 1; i >= 0; i--) {
        const date = new Date();
        
        if (interval === '1mo') {
          date.setMonth(date.getMonth() - i);
        } else {
          date.setDate(date.getDate() - (i * timeIncrement));
        }
        
        // Volatilite interval'e gÃ¶re ayarla
        let volatilityFactor;
        if (interval === '1d') volatilityFactor = 0.03; // %3 gÃ¼nlÃ¼k
        else if (interval === '1wk') volatilityFactor = 0.07; // %7 haftalÄ±k
        else volatilityFactor = 0.15; // %15 aylÄ±k
        
        const dailyChange = (Math.random() - 0.5) * volatilityFactor;
        currentPrice = currentPrice * (1 + dailyChange);
        
        // GÃ¼n iÃ§i aralÄ±k
        const range = currentPrice * (volatilityFactor * 0.5);
        const high = currentPrice + (Math.random() * range);
        const low = currentPrice - (Math.random() * range);
        const open = low + (Math.random() * (high - low));
        
        // Hacim - interval'e gÃ¶re ayarla
        let baseVolume = 50 + Math.random() * 100;
        if (interval === '1wk') baseVolume *= 5; // HaftalÄ±k hacim daha bÃ¼yÃ¼k
        else if (interval === '1mo') baseVolume *= 20; // AylÄ±k hacim Ã§ok daha bÃ¼yÃ¼k
        
        const volume = baseVolume * 1000000;
        
        data.push({
          tarih: formatDateForDisplay(date.toISOString().split('T')[0]),
          simdi: parseFloat(currentPrice.toFixed(2)),
          acilis: parseFloat(open.toFixed(2)),
          yuksek: parseFloat(high.toFixed(2)),
          dusuk: parseFloat(low.toFixed(2)),
          hacim: parseFloat((volume / 1000000).toFixed(2))
        });
      }
      
      return data.reverse(); // En yeni tarih baÅŸta
    }

    function getBasePriceForSymbol(symbol) {
      const priceMap = {
        'AAPL': 175, 'MSFT': 340, 'GOOGL': 135, 'AMZN': 145, 'TSLA': 250,
        'THYAO': 180, 'AKBNK': 45, 'GARAN': 95, 'ISCTR': 52, 'ASELS': 85,
        'BIST100': 8500, 'BTC-USD': 42000, 'ETH-USD': 2800
      };
      return priceMap[symbol] || 100;
    }

    // Web scraping fonksiyonlarÄ±
    async function fetchDataFromSource(symbol, period, interval, source) {
      try {
        switch (source) {
          case 'demo':
            return generateDemoData(symbol, period, interval);
            
          case 'yahoo':
            return await fetchYahooFinanceData(symbol, period, interval);
            
          case 'investing':
            return await fetchInvestingData(symbol, period, interval);
            
          case 'tradingview':
            return await fetchTradingViewData(symbol, period, interval);
            
          case 'bigpara':
            return await fetchBigParaData(symbol, period, interval);
            
          default:
            throw new Error('Bilinmeyen veri kaynaÄŸÄ±');
        }
      } catch (error) {
        console.error('Veri Ã§ekme hatasÄ±:', error);
        throw error;
      }
    }

    // GeliÅŸmiÅŸ Yahoo Finance veri Ã§ekme
    async function fetchYahooFinanceData(symbol, period, interval) {
      try {
        // Sembol formatÄ±nÄ± dÃ¼zenle
        let formattedSymbol = symbol;
        if (symbol.includes('THYAO') || symbol.includes('AKBNK') || symbol.includes('GARAN') || 
            symbol.includes('ASELS') || symbol.includes('ISCTR')) {
          if (!symbol.includes('.IS')) {
            formattedSymbol = symbol + '.IS'; // BIST hisseleri iÃ§in .IS ekle
          }
        }
        
        // Yahoo Finance API URL'si oluÅŸtur
        const url = `${DATA_SOURCES.yahoo.baseUrl}${formattedSymbol}?interval=${interval}&range=${period}`;
        
        console.log('Yahoo Finance URL:', url);
        
        // CORS proxy ile deneme
        const response = await fetchWithProxy(url);
        const data = await response.json();
        
        if (!data.chart || !data.chart.result || data.chart.result.length === 0) {
          throw new Error('Yahoo Finance\'dan veri alÄ±namadÄ±');
        }
        
        if (data.chart.error) {
          throw new Error(`Yahoo Finance API hatasÄ±: ${data.chart.error.description}`);
        }
        
        return parseYahooData(data.chart.result[0], interval);
        
      } catch (error) {
        console.warn('Yahoo Finance\'dan veri alÄ±namadÄ±, demo veri kullanÄ±lÄ±yor:', error.message);
        return generateDemoData(symbol, period, interval);
      }
    }

    function parseYahooData(result, interval = '1d') {
      const timestamps = result.timestamp;
      const quote = result.indicators.quote[0];
      const adjclose = result.indicators.adjclose ? result.indicators.adjclose[0].adjclose : quote.close;
      
      const data = [];
      
      for (let i = 0; i < timestamps.length; i++) {
        const date = new Date(timestamps[i] * 1000);
        
        // Null deÄŸerleri atla
        if (!quote.open[i] || !quote.high[i] || !quote.low[i] || !quote.close[i]) {
          continue;
        }
        
        // Hacim deÄŸerini interval'e gÃ¶re ayarla
        let volumeInMillions = (quote.volume[i] || 0) / 1000000;
        
        // HaftalÄ±k ve aylÄ±k veriler iÃ§in hacim deÄŸerleri genellikle daha bÃ¼yÃ¼k olur
        if (interval === '1wk' && volumeInMillions < 10) {
          volumeInMillions *= 5; // HaftalÄ±k iÃ§in Ã§arp
        } else if (interval === '1mo' && volumeInMillions < 50) {
          volumeInMillions *= 20; // AylÄ±k iÃ§in Ã§arp
        }
        
        data.push({
          tarih: formatDateForDisplay(date.toISOString().split('T')[0]),
          simdi: parseFloat((adjclose[i] || quote.close[i]).toFixed(2)),
          acilis: parseFloat(quote.open[i].toFixed(2)),
          yuksek: parseFloat(quote.high[i].toFixed(2)),
          dusuk: parseFloat(quote.low[i].toFixed(2)),
          hacim: parseFloat(volumeInMillions.toFixed(2))
        });
      }
      
      return data.reverse(); // En yeni tarih baÅŸta
    }

    // Tarih formatÄ± fonksiyonlarÄ±
    function parseTarih(str) {
      if (str.includes('-')) {
        const parts = str.split('-');
        return new Date(parts[0], parts[1] - 1, parts[2]);
      } else {
        const [day, month, year] = str.split('.');
        return new Date(year, month - 1, day);
      }
    }

    function formatDateForInput(date) {
      const yyyy = date.getFullYear();
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const dd = String(date.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function formatDateForDisplay(dateStr) {
      if (dateStr.includes('.')) return dateStr;
      
      try {
        const parts = dateStr.split(' ')[0].split('-');
        return `${parts[2]}.${parts[1]}.${parts[0]}`;
      } catch (error) {
        console.error('Tarih formatÄ± hatasÄ±:', error, dateStr);
        return dateStr;
      }
    }

    // PDF, CSV, Excel iÅŸleme fonksiyonlarÄ± (Ã¶nceki koddan aynÄ±)
    async function extractTextFromPDF(arrayBuffer) {
      try {
        const loadingTask = window.pdfjsLib.getDocument({ data: arrayBuffer });
        const pdfDoc = await loadingTask.promise;
        let fullText = '';
        
        for (let i = 1; i <= pdfDoc.numPages; i++) {
          const page = await pdfDoc.getPage(i);
          const content = await page.getTextContent();
          const lineMap = new Map();
          
          content.items.forEach(item => {
            const y = Math.round(item.transform[5]);
            if (!lineMap.has(y)) {
              lineMap.set(y, []);
            }
            lineMap.get(y).push({ text: item.str, x: item.transform[4] });
          });
          
          Array.from(lineMap.keys()).sort((a, b) => b - a).forEach(y => {
            const items = lineMap.get(y);
            items.sort((a, b) => a.x - b.x);
            const line = items.map(item => item.text).join(' ');
            if (line.trim()) {
              fullText += line + '\n';
            }
          });
        }
        return fullText;
      } catch (error) {
        console.error('PDF okuma hatasÄ±:', error);
        throw error;
      }
    }

    function processText(text) {
      const lines = text.split('\n')
        .map(line => line.trim())
        .filter(line => line && !line.includes('Tarih Åimdi'));
      
      const parsedData = [];
      
      lines.forEach(line => {
        const parts = line.split(/\s+/);
        if (parts.length >= 6) {
          try {
            const dateMatch = parts[0].match(/(\d{1,2})\.?(\d{1,2})\.?(\d{4})/);
            if (!dateMatch) return;
            
            let [_, day, month, year] = dateMatch;
            day = day.padStart(2, '0');
            month = month.padStart(2, '0');
            const tarih = `${day}.${month}.${year}`;
            
            const simdi = parseFloat(parts[1].replace(',', '.'));
            const acilis = parseFloat(parts[2].replace(',', '.'));
            const yuksek = parseFloat(parts[3].replace(',', '.'));
            const dusuk = parseFloat(parts[4].replace(',', '.'));
            const hacim = parseFloat(parts[5].replace('M', '').replace(',', '.'));
            
            if (!isNaN(simdi) && !isNaN(acilis) && !isNaN(yuksek) && 
                !isNaN(dusuk) && !isNaN(hacim) && simdi > 0 && hacim >= 0) {
              parsedData.push({ tarih, simdi, acilis, yuksek, dusuk, hacim });
            }
          } catch (error) {
            console.error('SatÄ±r iÅŸleme hatasÄ±:', error);
          }
        }
      });
      
      return parsedData.sort((a, b) => parseTarih(b.tarih) - parseTarih(a.tarih));
    }

    function processCSV(text) {
      const result = Papa.parse(text, {
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true
      });
      
      return result.data.map(row => {
        return {
          tarih: row.Tarih || row.tarih || row.Date || row.date,
          simdi: parseFloat(row.KapanÄ±ÅŸ || row.Åimdi || row.Close || row.simdi || 0),
          acilis: parseFloat(row.AÃ§Ä±lÄ±ÅŸ || row.Open || row.acilis || 0),
          yuksek: parseFloat(row.YÃ¼ksek || row.High || row.yuksek || 0),
          dusuk: parseFloat(row.DÃ¼ÅŸÃ¼k || row.Low || row.dusuk || 0),
          hacim: parseFloat(row.Hacim || row.Volume || row.hacim || 0)
        };
      }).filter(item => item.simdi > 0);
    }

    async function processExcel(arrayBuffer) {
      const workbook = XLSX.read(arrayBuffer, { type: 'array' });
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      const data = XLSX.utils.sheet_to_json(firstSheet);
      
      return data.map(row => {
        return {
          tarih: row.Tarih || row.Date || '',
          simdi: parseFloat(row.KapanÄ±ÅŸ || row.Close || row.Åimdi || 0),
          acilis: parseFloat(row.AÃ§Ä±lÄ±ÅŸ || row.Open || 0),
          yuksek: parseFloat(row.YÃ¼ksek || row.High || 0),
          dusuk: parseFloat(row.DÃ¼ÅŸÃ¼k || row.Low || 0),
          hacim: parseFloat(row.Hacim || row.Volume || 0)
        };
      }).filter(item => item.simdi > 0);
    }

    // Teknik analiz fonksiyonlarÄ± (Ã¶nceki koddan aynÄ±)
    function calculateSMA(data, period) {
      const sma = [];
      for (let i = period - 1; i < data.length; i++) {
        const sum = data.slice(i - period + 1, i + 1)
          .reduce((acc, val) => acc + val.simdi, 0);
        sma.push(sum / period);
      }
      return sma;
    }

    function calculateEMA(data, period) {
      const ema = [];
      const multiplier = 2 / (period + 1);
      
      const firstSMA = data.slice(0, period).reduce((sum, val) => sum + val.simdi, 0) / period;
      ema.push(firstSMA);
      
      for (let i = period; i < data.length; i++) {
        const currentEMA = (data[i].simdi - ema[ema.length - 1]) * multiplier + ema[ema.length - 1];
        ema.push(currentEMA);
      }
      return ema;
    }

    function calculateBollingerBands(data, period = 20, stdDev = 2) {
      const sma = calculateSMA(data, period);
      const bands = { upper: [], middle: sma, lower: [] };
      
      for (let i = period - 1; i < data.length; i++) {
        const slice = data.slice(i - period + 1, i + 1).map(d => d.simdi);
        const mean = sma[i - period + 1];
        const variance = slice.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / period;
        const std = Math.sqrt(variance);
        
        bands.upper.push(mean + (stdDev * std));
        bands.lower.push(mean - (stdDev * std));
      }
      
      return bands;
    }

    function calculateRSI(data, period = 14) {
      const rsi = [];
      let gains = 0;
      let losses = 0;
      
      for (let i = 1; i <= period; i++) {
        const change = data[i].simdi - data[i - 1].simdi;
        if (change > 0) gains += change;
        else losses += Math.abs(change);
      }
      
      let avgGain = gains / period;
      let avgLoss = losses / period;
      
      for (let i = period; i < data.length; i++) {
        const change = data[i].simdi - data[i - 1].simdi;
        
        if (change > 0) {
          avgGain = (avgGain * (period - 1) + change) / period;
          avgLoss = (avgLoss * (period - 1)) / period;
        } else {
          avgGain = (avgGain * (period - 1)) / period;
          avgLoss = (avgLoss * (period - 1) + Math.abs(change)) / period;
        }
        
        const rs = avgGain / avgLoss;
        rsi.push(100 - (100 / (1 + rs)));
      }
      
      return rsi;
    }

    // Ä°statistik ve analiz fonksiyonlarÄ± (Ã¶nceki koddan aynÄ±)
    function calculateStats(data) {
      if (data.length === 0) return null;
      
      const prices = data.map(d => d.simdi);
      const volumes = data.map(d => d.hacim);
      
      const currentPrice = prices[0];
      const previousPrice = prices[prices.length - 1];
      const changePercent = ((currentPrice - previousPrice) / previousPrice * 100).toFixed(2);
      
      const maxPrice = Math.max(...prices);
      const minPrice = Math.min(...prices);
      const avgVolume = (volumes.reduce((a, b) => a + b, 0) / volumes.length).toFixed(2);
      
      const returns = [];
      for (let i = 1; i < prices.length; i++) {
        returns.push((prices[i] - prices[i - 1]) / prices[i - 1]);
      }
      const avgReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
      const variance = returns.reduce((sum, r) => sum + Math.pow(r - avgReturn, 2), 0) / returns.length;
      const volatility = (Math.sqrt(variance) * Math.sqrt(252) * 100).toFixed(2);
      
      return {
        currentPrice: currentPrice.toFixed(2),
        changePercent,
        maxPrice: maxPrice.toFixed(2),
        minPrice: minPrice.toFixed(2),
        avgVolume,
        volatility,
        priceRange: ((maxPrice - minPrice) / minPrice * 100).toFixed(2)
      };
    }

    function performAIAnalysis(data) {
      const stats = calculateStats(data);
      const prices = data.map(d => d.simdi);
      const volumes = data.map(d => d.hacim);
      const highs = data.map(d => d.yuksek);
      const lows = data.map(d => d.dusuk);
      const opens = data.map(d => d.acilis);
      
      // GeliÅŸmiÅŸ Teknik Ä°ndikatÃ¶rler
      const sma20 = calculateSMA(data, 20);
      const sma50 = calculateSMA(data, Math.min(50, data.length));
      const sma200 = calculateSMA(data, Math.min(200, data.length));
      const ema12 = calculateEMA(data, 12);
      const ema26 = calculateEMA(data, 26);
      const rsi = calculateRSI(data);
      const bollingerBands = calculateBollingerBands(data);
      const macd = calculateMACD(data);
      const stochastic = calculateStochastic(data);
      const adx = calculateADX(data);
      
      // Mevcut deÄŸerler
      const currentPrice = prices[0];
      const currentVolume = volumes[0];
      const sma20Current = sma20[sma20.length - 1];
      const sma50Current = sma50[sma50.length - 1];
      const sma200Current = sma200[sma200.length - 1];
      const rsiCurrent = rsi[rsi.length - 1];
      const macdCurrent = macd.macd[macd.macd.length - 1];
      const macdSignal = macd.signal[macd.signal.length - 1];
      const stochK = stochastic.k[stochastic.k.length - 1];
      const adxCurrent = adx[adx.length - 1];
      
      // GeliÅŸmiÅŸ Analiz Sistemi
      let trendScore = 0;
      let signals = [];
      let tradingSignals = [];
      let riskFactors = [];
      let opportunities = [];
      
      // === TREND ANALÄ°ZÄ° ===
      const trendAnalysis = analyzeTrend(prices, sma20Current, sma50Current, sma200Current);
      trendScore += trendAnalysis.score;
      signals.push(...trendAnalysis.signals);
      
      // === MOMENTUM ANALÄ°ZÄ° ===
      const momentumAnalysis = analyzeMomentum(rsiCurrent, macdCurrent, macdSignal, stochK, adxCurrent);
      trendScore += momentumAnalysis.score;
      signals.push(...momentumAnalysis.signals);
      
      // === HACÄ°M ANALÄ°ZÄ° ===
      const volumeAnalysis = analyzeVolume(volumes, prices);
      trendScore += volumeAnalysis.score;
      signals.push(...volumeAnalysis.signals);
      
      // === VOLATILITE ANALÄ°ZÄ° ===
      const volatilityAnalysis = analyzeVolatility(data, bollingerBands);
      signals.push(...volatilityAnalysis.signals);
      riskFactors.push(...volatilityAnalysis.risks);
      
      // === DESTEK VE DÄ°RENÃ‡ SEVÄ°YELERÄ° ===
      const supportResistance = calculateAdvancedSupportResistance(data);
      
      // === FIBONACCI SEVÄ°YELERÄ° ===
      const fibonacciLevels = calculateFibonacciLevels(data);
      
      // === CHART PATTERN ANALÄ°ZÄ° ===
      const patternAnalysis = analyzeChartPatterns(data);
      signals.push(...patternAnalysis.signals);
      opportunities.push(...patternAnalysis.opportunities);
      
      // === ALIM-SATIM SÄ°NYALLERÄ° ===
      const tradingSignal = generateTradingSignal(trendScore, currentPrice, supportResistance, rsiCurrent, macdCurrent, adxCurrent);
      
      // === RÄ°SK YÃ–NETÄ°MÄ° ===
      const riskManagement = calculateRiskManagement(currentPrice, supportResistance, stats.volatility);
      
      // === POZÄ°SYON BÃœYÃœKLÃœÄÃœ ===
      const positionSizing = calculatePositionSizing(currentPrice, riskManagement.stopLoss, stats.volatility);
      
      // === HEDEFLERVe STRATEJÄ° ===
      const targets = calculatePriceTargets(currentPrice, supportResistance, fibonacciLevels, trendScore);
      
      // === MARKET SENTIMENT ===
      const marketSentiment = analyzeMarketSentiment(data, volumes, rsiCurrent, adxCurrent);
      
      return {
        stats,
        signals,
        tradingSignal,
        supportResistance,
        fibonacciLevels,
        riskManagement,
        positionSizing,
        targets,
        marketSentiment,
        patternAnalysis,
        technicalIndicators: {
          rsi: rsiCurrent,
          macd: { line: macdCurrent, signal: macdSignal },
          stochastic: stochK,
          adx: adxCurrent,
          sma20: sma20Current,
          sma50: sma50Current,
          sma200: sma200Current
        },
        trendScore,
        riskFactors,
        opportunities
      };
    }

    // GeliÅŸmiÅŸ Teknik Ä°ndikatÃ¶r HesaplamalarÄ±
    function calculateMACD(data, fast = 12, slow = 26, signal = 9) {
      const emaFast = calculateEMA(data, fast);
      const emaSlow = calculateEMA(data, slow);
      
      const macdLine = [];
      for (let i = 0; i < emaFast.length; i++) {
        if (emaSlow[i] !== undefined) {
          macdLine.push(emaFast[i] - emaSlow[i]);
        }
      }
      
      // MACD sinyali (MACD'nin EMA'sÄ±)
      const macdData = macdLine.map((value, index) => ({ simdi: value }));
      const macdSignal = calculateEMA(macdData, signal);
      
      return {
        macd: macdLine,
        signal: macdSignal,
        histogram: macdLine.map((m, i) => macdSignal[i] ? m - macdSignal[i] : 0)
      };
    }

    function calculateStochastic(data, k = 14, d = 3) {
      const stochK = [];
      const stochD = [];
      
      for (let i = k - 1; i < data.length; i++) {
        const period = data.slice(i - k + 1, i + 1);
        const highestHigh = Math.max(...period.map(p => p.yuksek));
        const lowestLow = Math.min(...period.map(p => p.dusuk));
        const currentClose = data[i].simdi;
        
        const kValue = ((currentClose - lowestLow) / (highestHigh - lowestLow)) * 100;
        stochK.push(kValue);
      }
      
      // %D (Stochastic %K'nÄ±n SMA'sÄ±)
      for (let i = d - 1; i < stochK.length; i++) {
        const dValue = stochK.slice(i - d + 1, i + 1).reduce((sum, val) => sum + val, 0) / d;
        stochD.push(dValue);
      }
      
      return { k: stochK, d: stochD };
    }

    function calculateADX(data, period = 14) {
      const adx = [];
      const plusDI = [];
      const minusDI = [];
      
      // Simplified ADX calculation
      for (let i = 1; i < data.length; i++) {
        const highDiff = data[i].yuksek - data[i - 1].yuksek;
        const lowDiff = data[i - 1].dusuk - data[i].dusuk;
        
        const plusDM = (highDiff > lowDiff && highDiff > 0) ? highDiff : 0;
        const minusDM = (lowDiff > highDiff && lowDiff > 0) ? lowDiff : 0;
        
        const tr = Math.max(
          data[i].yuksek - data[i].dusuk,
          Math.abs(data[i].yuksek - data[i - 1].simdi),
          Math.abs(data[i].dusuk - data[i - 1].simdi)
        );
        
        // Simplified ADX value (trend strength)
        if (i >= period) {
          const adxValue = Math.abs(plusDM - minusDM) / tr * 100;
          adx.push(Math.min(100, Math.max(0, adxValue)));
        }
      }
      
      return adx;
    }

    // GeliÅŸmiÅŸ Analiz FonksiyonlarÄ±
    function analyzeTrend(prices, sma20, sma50, sma200) {
      let score = 0;
      let signals = [];
      
      const currentPrice = prices[0];
      
      // Trend Direction
      if (currentPrice > sma20 && sma20 > sma50) {
        score += 2;
        signals.push({ text: "GÃ¼Ã§lÃ¼ yÃ¼kseliÅŸ trendi (Price > SMA20 > SMA50)", type: "bullish" });
      }
      
      if (sma20 > sma200) {
        score += 1;
        signals.push({ text: "Uzun vadeli yÃ¼kseliÅŸ trendi", type: "bullish" });
      }
      
      // Golden Cross & Death Cross
      if (sma50 > sma200) {
        score += 1;
        signals.push({ text: "Golden Cross sinyali aktif", type: "bullish" });
      } else if (sma50 < sma200) {
        score -= 1;
        signals.push({ text: "Death Cross sinyali aktif", type: "bearish" });
      }
      
      return { score, signals };
    }

    function analyzeMomentum(rsi, macd, macdSignal, stoch, adx) {
      let score = 0;
      let signals = [];
      
      // RSI Momentum
      if (rsi < 30) {
        score += 1;
        signals.push({ text: `RSI aÅŸÄ±rÄ± satÄ±m (${rsi.toFixed(1)}) - AlÄ±m fÄ±rsatÄ±`, type: "bullish" });
      } else if (rsi > 70) {
        score -= 1;
        signals.push({ text: `RSI aÅŸÄ±rÄ± alÄ±m (${rsi.toFixed(1)}) - SatÄ±ÅŸ sinyali`, type: "bearish" });
      }
      
      // MACD Momentum
      if (macd > macdSignal) {
        score += 1;
        signals.push({ text: "MACD yÃ¼kseliÅŸ sinyali", type: "bullish" });
      } else {
        score -= 1;
        signals.push({ text: "MACD dÃ¼ÅŸÃ¼ÅŸ sinyali", type: "bearish" });
      }
      
      // Stochastic
      if (stoch < 20) {
        score += 0.5;
        signals.push({ text: "Stochastic aÅŸÄ±rÄ± satÄ±m bÃ¶lgesinde", type: "bullish" });
      } else if (stoch > 80) {
        score -= 0.5;
        signals.push({ text: "Stochastic aÅŸÄ±rÄ± alÄ±m bÃ¶lgesinde", type: "bearish" });
      }
      
      // ADX Trend Strength
      if (adx > 25) {
        signals.push({ text: `GÃ¼Ã§lÃ¼ trend (ADX: ${adx.toFixed(1)})`, type: "neutral" });
      } else {
        signals.push({ text: `ZayÄ±f trend (ADX: ${adx.toFixed(1)})`, type: "neutral" });
      }
      
      return { score, signals };
    }

    function analyzeVolume(volumes, prices) {
      let score = 0;
      let signals = [];
      
      const avgVolume = volumes.reduce((a, b) => a + b, 0) / volumes.length;
      const recentVolume = volumes.slice(0, 5).reduce((a, b) => a + b, 0) / 5;
      
      // Volume Price Trend
      if (recentVolume > avgVolume * 1.5) {
        if (prices[0] > prices[5]) {
          score += 1;
          signals.push({ text: "YÃ¼ksek hacimle yÃ¼kseliÅŸ - GÃ¼Ã§lÃ¼ alÄ±m baskÄ±sÄ±", type: "bullish" });
        } else {
          score -= 1;
          signals.push({ text: "YÃ¼ksek hacimle dÃ¼ÅŸÃ¼ÅŸ - GÃ¼Ã§lÃ¼ satÄ±ÅŸ baskÄ±sÄ±", type: "bearish" });
        }
      }
      
      return { score, signals };
    }

    function analyzeVolatility(data, bollingerBands) {
      let signals = [];
      let risks = [];
      
      const currentPrice = data[0].simdi;
      const bbUpper = bollingerBands.upper[bollingerBands.upper.length - 1];
      const bbLower = bollingerBands.lower[bollingerBands.lower.length - 1];
      const bbMiddle = bollingerBands.middle[bollingerBands.middle.length - 1];
      
      const bbWidth = ((bbUpper - bbLower) / bbMiddle) * 100;
      
      if (currentPrice > bbUpper) {
        signals.push({ text: "Bollinger Ã¼st bandÄ±nÄ±n Ã¼zerinde - AÅŸÄ±rÄ± alÄ±m", type: "bearish" });
        risks.push("AÅŸÄ±rÄ± alÄ±m riski yÃ¼ksek");
      } else if (currentPrice < bbLower) {
        signals.push({ text: "Bollinger alt bandÄ±nÄ±n altÄ±nda - AÅŸÄ±rÄ± satÄ±m", type: "bullish" });
      }
      
      if (bbWidth > 20) {
        risks.push("YÃ¼ksek volatilite - Risk yÃ¶netimi kritik");
      } else if (bbWidth < 10) {
        signals.push({ text: "DÃ¼ÅŸÃ¼k volatilite - BÃ¼yÃ¼k hareket yakÄ±n", type: "neutral" });
      }
      
      return { signals, risks };
    }

    function calculateAdvancedSupportResistance(data) {
      const highs = data.map(d => d.yuksek);
      const lows = data.map(d => d.dusuk);
      const closes = data.map(d => d.simdi);
      
      // Pivot Points
      const currentHigh = highs[0];
      const currentLow = lows[0];
      const currentClose = closes[0];
      
      const pivot = (currentHigh + currentLow + currentClose) / 3;
      const r1 = 2 * pivot - currentLow;
      const r2 = pivot + (currentHigh - currentLow);
      const r3 = r2 + (currentHigh - currentLow);
      const s1 = 2 * pivot - currentHigh;
      const s2 = pivot - (currentHigh - currentLow);
      const s3 = s2 - (currentHigh - currentLow);
      
      // Dynamic Support/Resistance
      const supports = [];
      const resistances = [];
      
      // Son 50 gÃ¼nÃ¼n lokal min/max'larÄ±
      for (let i = 2; i < Math.min(50, data.length - 2); i++) {
        if (lows[i] < lows[i-1] && lows[i] < lows[i+1] && lows[i] < lows[i-2] && lows[i] < lows[i+2]) {
          supports.push(lows[i]);
        }
        if (highs[i] > highs[i-1] && highs[i] > highs[i+1] && highs[i] > highs[i-2] && highs[i] > highs[i+2]) {
          resistances.push(highs[i]);
        }
      }
      
      return {
        pivot,
        resistances: [r1, r2, r3, ...resistances.slice(0, 3)].filter(r => r > currentClose).sort((a, b) => a - b),
        supports: [s1, s2, s3, ...supports.slice(0, 3)].filter(s => s < currentClose).sort((a, b) => b - a)
      };
    }

    function calculateFibonacciLevels(data) {
      const prices = data.map(d => d.simdi);
      const high = Math.max(...prices);
      const low = Math.min(...prices);
      const diff = high - low;
      
      return {
        high,
        low,
        levels: {
          '23.6%': high - (diff * 0.236),
          '38.2%': high - (diff * 0.382),
          '50.0%': high - (diff * 0.5),
          '61.8%': high - (diff * 0.618),
          '78.6%': high - (diff * 0.786)
        }
      };
    }

    function analyzeChartPatterns(data) {
      let signals = [];
      let opportunities = [];
      
      const prices = data.map(d => d.simdi);
      const highs = data.map(d => d.yuksek);
      const lows = data.map(d => d.dusuk);
      
      // Double Top/Bottom Detection
      const recentHighs = highs.slice(0, 20);
      const recentLows = lows.slice(0, 20);
      
      // Head and Shoulders Pattern
      if (detectHeadAndShoulders(recentHighs)) {
        signals.push({ text: "Head and Shoulders formasyonu tespit edildi", type: "bearish" });
        opportunities.push("H&S formasyonu - SatÄ±ÅŸ fÄ±rsatÄ±");
      }
      
      // Ascending/Descending Triangle
      const trianglePattern = detectTrianglePattern(prices);
      if (trianglePattern) {
        signals.push({ text: `${trianglePattern} Ã¼Ã§gen formasyonu`, type: "neutral" });
        opportunities.push(`${trianglePattern} - KÄ±rÄ±lÄ±m bekleniyor`);
      }
      
      return { signals, opportunities };
    }

    function generateTradingSignal(trendScore, currentPrice, sr, rsi, macd, adx) {
      let signal = "BEKLE";
      let confidence = 0;
      let reason = [];
      
      if (trendScore > 3) {
        signal = "GÃœÃ‡LÃœ ALIM";
        confidence = Math.min(95, 60 + (trendScore * 5));
        reason.push("GÃ¼Ã§lÃ¼ yÃ¼kseliÅŸ trendi");
      } else if (trendScore > 1) {
        signal = "ALIM";
        confidence = Math.min(80, 50 + (trendScore * 10));
        reason.push("Pozitif trend sinyalleri");
      } else if (trendScore < -3) {
        signal = "GÃœÃ‡LÃœ SATIÅ";
        confidence = Math.min(95, 60 + (Math.abs(trendScore) * 5));
        reason.push("GÃ¼Ã§lÃ¼ dÃ¼ÅŸÃ¼ÅŸ trendi");
      } else if (trendScore < -1) {
        signal = "SATIÅ";
        confidence = Math.min(80, 50 + (Math.abs(trendScore) * 10));
        reason.push("Negatif trend sinyalleri");
      }
      
      // RSI confirmation
      if (rsi < 30 && signal.includes("ALIM")) {
        confidence += 10;
        reason.push("RSI aÅŸÄ±rÄ± satÄ±m konfirmasyonu");
      }
      
      // ADX confirmation
      if (adx > 25) {
        confidence += 5;
        reason.push("GÃ¼Ã§lÃ¼ trend konfirmasyonu");
      }
      
      return {
        action: signal,
        confidence: Math.min(95, confidence),
        reasons: reason,
        timestamp: new Date().toLocaleString('tr-TR')
      };
    }

    function calculateRiskManagement(currentPrice, sr, volatility) {
      const nearestSupport = sr.supports[0] || currentPrice * 0.95;
      const nearestResistance = sr.resistances[0] || currentPrice * 1.05;
      
      // Stop Loss calculation
      const stopLoss = nearestSupport * 0.98; // 2% buffer below support
      const stopLossPercent = ((currentPrice - stopLoss) / currentPrice * 100);
      
      // Position size based on risk
      const maxRiskPercent = 2; // Portfolio'nun max %2'si risk
      const positionSizePercent = maxRiskPercent / stopLossPercent;
      
      return {
        stopLoss: stopLoss.toFixed(2),
        stopLossPercent: stopLossPercent.toFixed(2),
        nearestSupport: nearestSupport.toFixed(2),
        nearestResistance: nearestResistance.toFixed(2),
        riskLevel: volatility > 30 ? "YÃœKSEK" : volatility > 20 ? "ORTA" : "DÃœÅÃœK"
      };
    }

    function calculatePositionSizing(currentPrice, stopLoss, volatility) {
      const riskPerTrade = 2; // %2 risk per trade
      const stopLossDistance = ((currentPrice - parseFloat(stopLoss)) / currentPrice * 100);
      
      const positionSize = riskPerTrade / stopLossDistance * 100;
      
      return {
        recommendedSize: Math.min(20, Math.max(1, positionSize)).toFixed(1) + "%",
        maxPositionSize: volatility > 30 ? "10%" : volatility > 20 ? "15%" : "20%",
        riskPerTrade: riskPerTrade + "%"
      };
    }

    function calculatePriceTargets(currentPrice, sr, fibonacci, trendScore) {
      const targets = [];
      
      // Resistance based targets
      if (sr.resistances.length > 0) {
        targets.push({
          level: sr.resistances[0].toFixed(2),
          type: "Ä°lk DirenÃ§",
          probability: "70%",
          timeframe: "KÄ±sa Vadeli"
        });
        
        if (sr.resistances.length > 1) {
          targets.push({
            level: sr.resistances[1].toFixed(2),
            type: "Ä°kinci DirenÃ§", 
            probability: "50%",
            timeframe: "Orta Vadeli"
          });
        }
      }
      
      // Fibonacci targets
      const fibLevels = Object.values(fibonacci.levels);
      const nearestFib = fibLevels.find(level => level > currentPrice);
      if (nearestFib) {
        targets.push({
          level: nearestFib.toFixed(2),
          type: "Fibonacci Retracement",
          probability: "60%",
          timeframe: "Teknik"
        });
      }
      
      return targets;
    }

    function analyzeMarketSentiment(data, volumes, rsi, adx) {
      let sentiment = "NÃ–TR";
      let strength = 50;
      
      const avgVolume = volumes.reduce((a, b) => a + b, 0) / volumes.length;
      const recentVolume = volumes.slice(0, 5).reduce((a, b) => a + b, 0) / 5;
      
      // Price momentum
      const priceChange = ((data[0].simdi - data[5].simdi) / data[5].simdi) * 100;
      
      if (priceChange > 2 && recentVolume > avgVolume * 1.2) {
        sentiment = "GÃœÃ‡LÃœ BOÄA";
        strength = 75;
      } else if (priceChange > 0 && rsi > 50) {
        sentiment = "BOÄA";
        strength = 65;
      } else if (priceChange < -2 && recentVolume > avgVolume * 1.2) {
        sentiment = "GÃœÃ‡LÃœ AYI";
        strength = 25;
      } else if (priceChange < 0 && rsi < 50) {
        sentiment = "AYI";
        strength = 35;
      }
      
      return {
        sentiment,
        strength,
        indicators: {
          priceChange: priceChange.toFixed(2) + "%",
          volumeRatio: (recentVolume / avgVolume).toFixed(2),
          rsiPosition: rsi > 70 ? "AÅŸÄ±rÄ± AlÄ±m" : rsi < 30 ? "AÅŸÄ±rÄ± SatÄ±m" : "NÃ¶tr",
          trendStrength: adx > 25 ? "GÃ¼Ã§lÃ¼" : "ZayÄ±f"
        }
      };
    }

    // Helper functions for pattern detection
    function detectHeadAndShoulders(highs) {
      if (highs.length < 5) return false;
      
      // Simplified H&S detection
      const leftShoulder = highs[4];
      const head = highs[2];
      const rightShoulder = highs[0];
      
      return head > leftShoulder && head > rightShoulder && 
             Math.abs(leftShoulder - rightShoulder) < head * 0.02;
    }

    function detectTrianglePattern(prices) {
      if (prices.length < 10) return null;
      
      const recent = prices.slice(0, 10);
      const high = Math.max(...recent);
      const low = Math.min(...recent);
      const range = high - low;
      
      if (range < recent[0] * 0.05) {
        return "SÄ±kÄ±ÅŸan";
      }
      
      return null;
    }

    // UI Ä°ÅŸlemleri
    function getFilteredData() {
      const filterStart = document.getElementById('filter-start').value;
      const filterEnd = document.getElementById('filter-end').value;
      
      return stockData.filter(item => {
        const itemDate = parseTarih(item.tarih);
        if (filterStart && itemDate < new Date(filterStart)) return false;
        if (filterEnd && itemDate > new Date(filterEnd)) return false;
        return true;
      });
    }

    function displayStats(stats) {
      if (!stats) return;
      
      const container = document.getElementById('stats-container');
      container.style.display = 'grid';
      container.innerHTML = `
        <div class="stat-card">
          <div class="stat-label">GÃ¼ncel Fiyat</div>
          <div class="stat-value">${stats.currentPrice}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">DeÄŸiÅŸim</div>
          <div class="stat-value" style="color: ${stats.changePercent >= 0 ? '#10b981' : '#ef4444'}">
            ${stats.changePercent >= 0 ? '+' : ''}${stats.changePercent}%
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-label">En YÃ¼ksek</div>
          <div class="stat-value">${stats.maxPrice}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">En DÃ¼ÅŸÃ¼k</div>
          <div class="stat-value">${stats.minPrice}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Ort. Hacim</div>
          <div class="stat-value">${stats.avgVolume}M</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Volatilite</div>
          <div class="stat-value">${stats.volatility}%</div>
        </div>
      `;
    }

    function renderCharts(data) {
      const contentBody = document.getElementById('content-body');
      contentBody.innerHTML = '';
      
      // Veri bilgisi baÅŸlÄ±ÄŸÄ±
      const infoHeader = document.createElement('div');
      infoHeader.style.cssText = `
        background: #f8fafc; 
        border: 1px solid #e2e8f0; 
        border-radius: 6px; 
        padding: 8px 12px; 
        margin-bottom: 16px;
        font-size: 0.9em;
        color: #475569;
      `;
      infoHeader.innerHTML = `
        <strong>ğŸ“Š Grafik Bilgisi:</strong> ${data.length} kayÄ±t | 
        ${data[data.length - 1].tarih} - ${data[0].tarih} | 
        <span style="color: #0ea5e9;">Son gÃ¼ncelleme: ${new Date().toLocaleString('tr-TR')}</span>
      `;
      contentBody.appendChild(infoHeader);
      
      const mainChartContainer = document.createElement('div');
      mainChartContainer.style.height = '400px';
      mainChartContainer.style.marginBottom = '20px';
      const canvas1 = document.createElement('canvas');
      mainChartContainer.appendChild(canvas1);
      contentBody.appendChild(mainChartContainer);
      
      const reversedData = [...data].reverse();
      const labels = reversedData.map(item => item.tarih);
      const prices = reversedData.map(item => item.simdi);
      
      const datasets = [
        {
          label: 'KapanÄ±ÅŸ FiyatÄ±',
          data: prices,
          borderColor: '#4f46e5',
          backgroundColor: 'rgba(79, 70, 229, 0.1)',
          fill: false,
          tension: 0.1
        }
      ];
      
      if (document.getElementById('ind-sma').checked) {
        const sma = calculateSMA(reversedData, 20);
        datasets.push({
          label: 'SMA (20)',
          data: Array(19).fill(null).concat(sma),
          borderColor: '#ef4444',
          borderDash: [5, 5],
          fill: false
        });
      }
      
      if (document.getElementById('ind-ema').checked) {
        const ema = calculateEMA(reversedData, 20);
        datasets.push({
          label: 'EMA (20)',
          data: Array(19).fill(null).concat(ema),
          borderColor: '#10b981',
          borderDash: [5, 5],
          fill: false
        });
      }
      
      if (document.getElementById('ind-bollinger').checked) {
        const bands = calculateBollingerBands(reversedData);
        datasets.push({
          label: 'Bollinger Ãœst',
          data: Array(19).fill(null).concat(bands.upper),
          borderColor: '#6b7280',
          borderDash: [2, 2],
          fill: false
        });
        datasets.push({
          label: 'Bollinger Alt',
          data: Array(19).fill(null).concat(bands.lower),
          borderColor: '#6b7280',
          borderDash: [2, 2],
          fill: false
        });
      }
      
      if (charts.main) charts.main.destroy();
      charts.main = new Chart(canvas1.getContext('2d'), {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index',
            axis: 'x'
          },
          onHover: (event, activeElements) => {
            canvas1.style.cursor = activeElements.length > 0 ? 'pointer' : 'crosshair';
          },
          onClick: (event, activeElements) => {
            if (activeElements.length > 0) {
              const datasetIndex = activeElements[0].datasetIndex;
              const index = activeElements[0].index;
              
              // Sadece ana fiyat verisine tÄ±klandÄ±ÄŸÄ±nda gÃ¶ster
              if (datasetIndex === 0) {
                const item = reversedData[index];
                
                // Ã–nceki popup'Ä± temizle
                const existingPopup = document.querySelector('.chart-popup');
                if (existingPopup) existingPopup.remove();
                
                // Canvas'Ä±n pozisyonunu al
                const rect = canvas1.getBoundingClientRect();
                const canvasPosition = Chart.helpers.getRelativePosition(event, charts.main);
                
                // TÄ±klanan nokta bilgilerini gÃ¶ster
                const infoDiv = document.createElement('div');
                infoDiv.className = 'chart-popup';
                infoDiv.style.position = 'fixed';
                infoDiv.style.top = (rect.top + canvasPosition.y - 10) + 'px';
                infoDiv.style.left = (rect.left + canvasPosition.x + 10) + 'px';
                infoDiv.style.background = 'rgba(0, 0, 0, 0.95)';
                infoDiv.style.color = 'white';
                infoDiv.style.padding = '16px';
                infoDiv.style.borderRadius = '12px';
                infoDiv.style.zIndex = '1000';
                infoDiv.style.fontSize = '14px';
                infoDiv.style.boxShadow = '0 8px 32px rgba(0,0,0,0.4)';
                infoDiv.style.maxWidth = '280px';
                infoDiv.style.border = '1px solid rgba(255,255,255,0.1)';
                
                // DeÄŸiÅŸim hesapla
                let changeText = '-';
                let changeColor = '#6b7280';
                let changeIcon = '';
                if (index > 0) {
                  const prevPrice = reversedData[index - 1].simdi;
                  const change = ((item.simdi - prevPrice) / prevPrice * 100);
                  changeText = (change >= 0 ? '+' : '') + change.toFixed(2) + '%';
                  changeColor = change >= 0 ? '#10b981' : '#ef4444';
                  changeIcon = change >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';
                }
                
                // Hacim deÄŸiÅŸimi
                let volumeChangeText = '-';
                let volumeChangeIcon = '';
                if (index > 0) {
                  const prevVolume = reversedData[index - 1].hacim;
                  if (prevVolume > 0) {
                    const volumeChange = ((item.hacim - prevVolume) / prevVolume * 100);
                    volumeChangeText = (volumeChange >= 0 ? '+' : '') + volumeChange.toFixed(1) + '%';
                    volumeChangeIcon = volumeChange >= 0 ? 'ğŸ“Š' : 'ğŸ“‰';
                  }
                }
                
                // GÃ¼n iÃ§i hareket
                const dailyRange = ((item.yuksek - item.dusuk) / item.dusuk * 100).toFixed(2);
                const rangeIcon = dailyRange > 3 ? 'âš¡' : dailyRange > 1.5 ? 'ğŸ“Š' : 'â–';
                
                // Position gÃ¶stergesi (kapanÄ±ÅŸ fiyatÄ±nÄ±n gÃ¼n iÃ§i aralÄ±ktaki yeri)
                const positionInRange = ((item.simdi - item.dusuk) / (item.yuksek - item.dusuk) * 100).toFixed(0);
                let positionText = '';
                if (positionInRange > 75) positionText = 'ğŸ”¥ GÃ¼Ã§lÃ¼ kapanÄ±ÅŸ';
                else if (positionInRange > 50) positionText = 'ğŸ’ª Pozitif kapanÄ±ÅŸ';
                else if (positionInRange > 25) positionText = 'ğŸ“Š NÃ¶tr kapanÄ±ÅŸ';
                else positionText = 'â„ï¸ ZayÄ±f kapanÄ±ÅŸ';
                
                infoDiv.innerHTML = `
                  <div style="font-weight: bold; margin-bottom: 12px; color: #4f46e5; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px;">
                    ğŸ“Š ${item.tarih} - ${selectedStockSymbol || 'Hisse'}
                  </div>
                  
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                    <div>
                      <div style="font-size: 12px; opacity: 0.7; margin-bottom: 2px;">KapanÄ±ÅŸ</div>
                      <div style="font-size: 18px; font-weight: bold; color: #ffffff;">${item.simdi.toFixed(2)}</div>
                    </div>
                    <div>
                      <div style="font-size: 12px; opacity: 0.7; margin-bottom: 2px;">DeÄŸiÅŸim</div>
                      <div style="font-size: 16px; font-weight: bold; color: ${changeColor};">${changeIcon} ${changeText}</div>
                    </div>
                  </div>
                  
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; font-size: 13px;">
                    <div>AÃ§Ä±lÄ±ÅŸ: <strong>${item.acilis.toFixed(2)}</strong></div>
                    <div>Hacim: <strong>${item.hacim.toFixed(2)}M</strong></div>
                    <div style="color: #10b981;">YÃ¼ksek: <strong>${item.yuksek.toFixed(2)}</strong></div>
                    <div>H.DeÄŸiÅŸim: <strong>${volumeChangeIcon} ${volumeChangeText}</strong></div>
                    <div style="color: #ef4444;">DÃ¼ÅŸÃ¼k: <strong>${item.dusuk.toFixed(2)}</strong></div>
                    <div>AralÄ±k: <strong>${rangeIcon} ${dailyRange}%</strong></div>
                  </div>
                  
                  <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px; margin-bottom: 12px;">
                    <div style="font-size: 12px; opacity: 0.8; margin-bottom: 4px;">GÃ¼n Ä°Ã§i Konum</div>
                    <div style="font-size: 13px; font-weight: bold;">${positionText} (${positionInRange}%)</div>
                  </div>
                  
                  <div style="font-size: 11px; opacity: 0.6; text-align: center; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 8px;">
                    ğŸ’¡ Kapatmak iÃ§in dÄ±ÅŸarÄ±ya tÄ±klayÄ±n | ğŸ” YakÄ±nlaÅŸtÄ±rmak iÃ§in scroll yapÄ±n
                  </div>
                `;
                
                document.body.appendChild(infoDiv);
                
                // Popup'Ä± ekranÄ±n dÄ±ÅŸÄ±na taÅŸtÄ±ÄŸÄ±nÄ± kontrol et
                const popupRect = infoDiv.getBoundingClientRect();
                if (popupRect.right > window.innerWidth) {
                  infoDiv.style.left = (rect.left + canvasPosition.x - popupRect.width - 10) + 'px';
                }
                if (popupRect.bottom > window.innerHeight) {
                  infoDiv.style.top = (rect.top + canvasPosition.y - popupRect.height + 10) + 'px';
                }
                if (popupRect.top < 0) {
                  infoDiv.style.top = '10px';
                }
                
                // DÄ±ÅŸarÄ± tÄ±klandÄ±ÄŸÄ±nda kapat
                const closeInfo = (e) => {
                  if (!infoDiv.contains(e.target)) {
                    infoDiv.remove();
                    document.removeEventListener('click', closeInfo);
                  }
                };
                
                setTimeout(() => {
                  document.addEventListener('click', closeInfo);
                }, 100);
              }
            }
          },
          plugins: {
            legend: {
              position: 'top'
            },
            title: {
              display: true,
              text: `${selectedStockSymbol || 'Hisse Senedi'} - Fiyat Analizi`,
              font: {
                size: 16,
                weight: 'bold'
              }
            },
            tooltip: {
              enabled: true,
              mode: 'index',
              intersect: false,
              position: 'nearest',
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: 'white',
              bodyColor: 'white',
              borderColor: '#4f46e5',
              borderWidth: 1,
              cornerRadius: 8,
              displayColors: true,
              caretPadding: 10,
              caretSize: 8,
              xAlign: 'center',
              yAlign: 'top',
              callbacks: {
                title: function(context) {
                  return `ğŸ“Š ${context[0].label}`;
                },
                label: function(context) {
                  const datasetLabel = context.dataset.label;
                  const value = context.formattedValue;
                  
                  if (datasetLabel === 'KapanÄ±ÅŸ FiyatÄ±') {
                    const dataIndex = context.dataIndex;
                    if (dataIndex > 0) {
                      const currentPrice = context.parsed.y;
                      const prevPrice = context.chart.data.datasets[0].data[dataIndex - 1];
                      const change = ((currentPrice - prevPrice) / prevPrice * 100);
                      const changeIcon = change >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';
                      return `${changeIcon} ${datasetLabel}: ${value} (${change >= 0 ? '+' : ''}${change.toFixed(2)}%)`;
                    }
                  }
                  
                  return `${datasetLabel}: ${value}`;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                maxTicksLimit: 10,
                maxRotation: 45,
                minRotation: 45
              }
            },
            y: {
              position: 'right'
            }
          }
        }
      });
      
      // Hacim grafiÄŸi
      const volumeContainer = document.createElement('div');
      volumeContainer.style.height = '200px';
      const canvas2 = document.createElement('canvas');
      volumeContainer.appendChild(canvas2);
      contentBody.appendChild(volumeContainer);
      
      const volumes = reversedData.map(item => item.hacim);
      
      // Hacim grafiÄŸi tÃ¼rÃ¼nÃ¼ belirle
      const isLineChart = document.getElementById('volume-line-chart').checked;
      const chartType = isLineChart ? 'line' : 'bar';
      
      // Veri setlerini grafik tÃ¼rÃ¼ne gÃ¶re ayarla
      const volumeDatasets = [{
        label: 'Ä°ÅŸlem Hacmi (Milyon)',
        data: volumes,
        backgroundColor: isLineChart ? 'transparent' : volumes.map((v, i) => 
          i > 0 && prices[i] > prices[i-1] ? 'rgba(16, 185, 129, 0.5)' : 'rgba(239, 68, 68, 0.5)'
        ),
        borderColor: isLineChart ? '#82ca9d' : 'transparent',
        fill: isLineChart ? false : true,
        tension: isLineChart ? 0.1 : 0
      }];
      
      if (document.getElementById('ind-volume-avg').checked) {
        const avgVolume = volumes.reduce((a, b) => a + b, 0) / volumes.length;
        volumeDatasets.push({
          label: 'Ortalama Hacim',
          data: Array(volumes.length).fill(avgVolume),
          borderColor: '#6b7280',
          borderDash: [10, 5],
          fill: false,
          pointRadius: 0,
          type: 'line'
        });
      }
      
      if (charts.volume) charts.volume.destroy();
      charts.volume = new Chart(canvas2.getContext('2d'), {
        type: chartType,
        data: { labels, datasets: volumeDatasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          onHover: (event, activeElements) => {
            canvas2.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
          },
          onClick: (event, activeElements) => {
            if (activeElements.length > 0) {
              const datasetIndex = activeElements[0].datasetIndex;
              const index = activeElements[0].index;
              
              // Sadece hacim verisine tÄ±klandÄ±ÄŸÄ±nda gÃ¶ster
              if (datasetIndex === 0) {
                const item = reversedData[index];
                
                // Ã–nceki popup'Ä± temizle
                const existingPopup = document.querySelector('.chart-popup');
                if (existingPopup) existingPopup.remove();
                
                // Canvas'Ä±n pozisyonunu al
                const rect = canvas2.getBoundingClientRect();
                const canvasPosition = Chart.helpers.getRelativePosition(event, charts.volume);
                
                // DeÄŸiÅŸim hesapla
                let priceChangeText = '-';
                let priceChangeColor = '#6b7280';
                let priceChangeIcon = '';
                let volumeChangeText = '-';
                let volumeChangeIcon = '';
                
                if (index > 0) {
                  const prevPrice = reversedData[index - 1].simdi;
                  const priceChange = ((item.simdi - prevPrice) / prevPrice * 100);
                  priceChangeText = (priceChange >= 0 ? '+' : '') + priceChange.toFixed(2) + '%';
                  priceChangeColor = priceChange >= 0 ? '#10b981' : '#ef4444';
                  priceChangeIcon = priceChange >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';
                  
                  const prevVolume = reversedData[index - 1].hacim;
                  if (prevVolume > 0) {
                    const volumeChange = ((item.hacim - prevVolume) / prevVolume * 100);
                    volumeChangeText = (volumeChange >= 0 ? '+' : '') + volumeChange.toFixed(1) + '%';
                    volumeChangeIcon = volumeChange >= 0 ? 'ğŸ“Š' : 'ğŸ“‰';
                  }
                }
                
                // Hacim analizi
                const avgVolume = volumes.reduce((a, b) => a + b, 0) / volumes.length;
                const volumeRatio = (item.hacim / avgVolume).toFixed(2);
                let volumeAnalysis = '';
                if (volumeRatio > 2) volumeAnalysis = 'ğŸ”¥ Ã‡ok yÃ¼ksek hacim';
                else if (volumeRatio > 1.5) volumeAnalysis = 'ğŸ“ˆ YÃ¼ksek hacim';
                else if (volumeRatio > 0.7) volumeAnalysis = 'ğŸ“Š Normal hacim';
                else volumeAnalysis = 'ğŸ“‰ DÃ¼ÅŸÃ¼k hacim';
                
                // Fiyat-hacim iliÅŸkisi
                let priceVolumeRelation = '';
                if (index > 0) {
                  const priceUp = item.simdi > reversedData[index - 1].simdi;
                  const volumeUp = item.hacim > reversedData[index - 1].hacim;
                  
                  if (priceUp && volumeUp) priceVolumeRelation = 'ğŸ’ª GÃ¼Ã§lÃ¼ yÃ¼kseliÅŸ (Fiyatâ†— + Hacimâ†—)';
                  else if (!priceUp && volumeUp) priceVolumeRelation = 'âš ï¸ GÃ¼Ã§lÃ¼ dÃ¼ÅŸÃ¼ÅŸ (Fiyatâ†˜ + Hacimâ†—)';
                  else if (priceUp && !volumeUp) priceVolumeRelation = 'ğŸ¤” ZayÄ±f yÃ¼kseliÅŸ (Fiyatâ†— + Hacimâ†˜)';
                  else priceVolumeRelation = 'ğŸ“Š ZayÄ±f dÃ¼ÅŸÃ¼ÅŸ (Fiyatâ†˜ + Hacimâ†˜)';
                }
                
                // TÄ±klanan hacim bilgilerini gÃ¶ster
                const infoDiv = document.createElement('div');
                infoDiv.className = 'chart-popup';
                infoDiv.style.position = 'fixed';
                infoDiv.style.top = (rect.top + canvasPosition.y - 10) + 'px';
                infoDiv.style.left = (rect.left + canvasPosition.x + 10) + 'px';
                infoDiv.style.background = 'rgba(0, 0, 0, 0.95)';
                infoDiv.style.color = 'white';
                infoDiv.style.padding = '16px';
                infoDiv.style.borderRadius = '12px';
                infoDiv.style.zIndex = '1000';
                infoDiv.style.fontSize = '14px';
                infoDiv.style.boxShadow = '0 8px 32px rgba(0,0,0,0.4)';
                infoDiv.style.maxWidth = '300px';
                infoDiv.style.border = '1px solid rgba(255,255,255,0.1)';
                
                infoDiv.innerHTML = `
                  <div style="font-weight: bold; margin-bottom: 12px; color: #4f46e5; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px;">
                    ğŸ“Š ${item.tarih} - Hacim Analizi
                  </div>
                  
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                    <div>
                      <div style="font-size: 12px; opacity: 0.7; margin-bottom: 2px;">Ä°ÅŸlem Hacmi</div>
                      <div style="font-size: 18px; font-weight: bold; color: #ffffff;">${item.hacim.toFixed(2)}M</div>
                    </div>
                    <div>
                      <div style="font-size: 12px; opacity: 0.7; margin-bottom: 2px;">Hacim DeÄŸiÅŸimi</div>
                      <div style="font-size: 16px; font-weight: bold;">${volumeChangeIcon} ${volumeChangeText}</div>
                    </div>
                  </div>
                  
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; font-size: 13px;">
                    <div>KapanÄ±ÅŸ: <strong>${item.simdi.toFixed(2)}</strong></div>
                    <div>Ort. Hacim: <strong>${avgVolume.toFixed(2)}M</strong></div>
                    <div>F. DeÄŸiÅŸim: <strong style="color: ${priceChangeColor};">${priceChangeIcon} ${priceChangeText}</strong></div>
                    <div>Hacim OranÄ±: <strong>${volumeRatio}x</strong></div>
                  </div>
                  
                  <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 6px; margin-bottom: 12px;">
                    <div style="font-size: 12px; opacity: 0.8; margin-bottom: 6px;">Hacim DeÄŸerlendirmesi</div>
                    <div style="font-size: 13px; font-weight: bold; margin-bottom: 8px;">${volumeAnalysis}</div>
                    ${priceVolumeRelation ? `<div style="font-size: 12px; opacity: 0.9;">${priceVolumeRelation}</div>` : ''}
                  </div>
                  
                  <div style="font-size: 11px; opacity: 0.6; text-align: center; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 8px;">
                    ğŸ’¡ Kapatmak iÃ§in dÄ±ÅŸarÄ±ya tÄ±klayÄ±n | ğŸ“Š Hacim analizi
                  </div>
                `;
                
                document.body.appendChild(infoDiv);
                
                // Popup'Ä± ekranÄ±n dÄ±ÅŸÄ±na taÅŸtÄ±ÄŸÄ±nÄ± kontrol et
                const popupRect = infoDiv.getBoundingClientRect();
                if (popupRect.right > window.innerWidth) {
                  infoDiv.style.left = (rect.left + canvasPosition.x - popupRect.width - 10) + 'px';
                }
                if (popupRect.bottom > window.innerHeight) {
                  infoDiv.style.top = (rect.top + canvasPosition.y - popupRect.height + 10) + 'px';
                }
                if (popupRect.top < 0) {
                  infoDiv.style.top = '10px';
                }
                
                const closeInfo = (e) => {
                  if (!infoDiv.contains(e.target)) {
                    infoDiv.remove();
                    document.removeEventListener('click', closeInfo);
                  }
                };
                
                setTimeout(() => {
                  document.addEventListener('click', closeInfo);
                }, 100);
              }
            }
          },
          plugins: {
            legend: {
              position: 'top'
            },
            title: {
              display: true,
              text: `${selectedStockSymbol || 'Hisse Senedi'} - Ä°ÅŸlem Hacmi`,
              font: {
                size: 14,
                weight: 'bold'
              }
            },
            tooltip: {
              enabled: true,
              mode: 'index',
              intersect: false,
              position: 'nearest',
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: 'white',
              bodyColor: 'white',
              borderColor: '#4f46e5',
              borderWidth: 1,
              cornerRadius: 8,
              displayColors: true,
              caretPadding: 10,
              caretSize: 8,
              xAlign: 'center',
              yAlign: 'top',
              callbacks: {
                title: function(context) {
                  return `ğŸ“Š ${context[0].label}`;
                },
                label: function(context) {
                  const datasetLabel = context.dataset.label;
                  const value = context.formattedValue;
                  
                  if (datasetLabel.includes('Ä°ÅŸlem Hacmi')) {
                    const dataIndex = context.dataIndex;
                    const priceChange = dataIndex > 0 ? 
                      ((reversedData[dataIndex].simdi - reversedData[dataIndex-1].simdi) / reversedData[dataIndex-1].simdi * 100) : 0;
                    
                    const volumeChange = dataIndex > 0 ? 
                      ((reversedData[dataIndex].hacim - reversedData[dataIndex-1].hacim) / reversedData[dataIndex-1].hacim * 100) : 0;
                    
                    return [
                      `ğŸ“Š ${datasetLabel}: ${value}M`,
                      `ğŸ“ˆ Fiyat DeÄŸiÅŸimi: ${priceChange >= 0 ? '+' : ''}${priceChange.toFixed(2)}%`,
                      `ğŸ“Š Hacim DeÄŸiÅŸimi: ${volumeChange >= 0 ? '+' : ''}${volumeChange.toFixed(1)}%`
                    ];
                  }
                  
                  return `${datasetLabel}: ${value}`;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                maxTicksLimit: 10,
                maxRotation: 45,
                minRotation: 45
              }
            },
            y: {
              position: 'right'
            }
          }
        }
      });
    }

    function renderTable(data) {
      const contentBody = document.getElementById('content-body');
      contentBody.innerHTML = '';
      
      // Veri bilgisi baÅŸlÄ±ÄŸÄ±
      const infoHeader = document.createElement('div');
      infoHeader.style.cssText = `
        background: #f8fafc; 
        border: 1px solid #e2e8f0; 
        border-radius: 6px; 
        padding: 8px 12px; 
        margin-bottom: 16px;
        font-size: 0.9em;
        color: #475569;
      `;
      infoHeader.innerHTML = `
        <strong>ğŸ“‹ Tablo Bilgisi:</strong> ${data.length} kayÄ±t | 
        ${data[data.length - 1].tarih} - ${data[0].tarih} | 
        <span style="color: #0ea5e9;">Son gÃ¼ncelleme: ${new Date().toLocaleString('tr-TR')}</span>
      `;
      contentBody.appendChild(infoHeader);
      
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      
      ['Tarih', 'KapanÄ±ÅŸ', 'DeÄŸiÅŸim %', 'AÃ§Ä±lÄ±ÅŸ', 'YÃ¼ksek', 'DÃ¼ÅŸÃ¼k', 'Hacim (M)'].forEach(text => {
        const th = document.createElement('th');
        th.textContent = text;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);
      
      const tbody = document.createElement('tbody');
      data.forEach((item, index) => {
        const row = document.createElement('tr');
        
        const tdTarih = document.createElement('td');
        tdTarih.textContent = item.tarih;
        row.appendChild(tdTarih);
        
        const tdSimdi = document.createElement('td');
        tdSimdi.textContent = item.simdi.toFixed(2);
        tdSimdi.style.fontWeight = '600';
        row.appendChild(tdSimdi);
        
        const tdDegisim = document.createElement('td');
        if (index < data.length - 1) {
          const prevPrice = data[index + 1].simdi;
          const change = ((item.simdi - prevPrice) / prevPrice * 100);
          tdDegisim.textContent = change.toFixed(2) + '%';
          tdDegisim.style.color = change >= 0 ? '#10b981' : '#ef4444';
          tdDegisim.style.fontWeight = '600';
        } else {
          tdDegisim.textContent = '-';
        }
        row.appendChild(tdDegisim);
        
        [item.acilis, item.yuksek, item.dusuk, item.hacim].forEach(value => {
          const td = document.createElement('td');
          td.textContent = value.toFixed(2);
          row.appendChild(td);
        });
        
        tbody.appendChild(row);
      });
      table.appendChild(tbody);
      contentBody.appendChild(table);
    }

    function renderContent() {
      const filtered = getFilteredData();
      
      if (filtered.length === 0) {
        document.getElementById('content-body').innerHTML = 
          '<div style="text-align:center; padding:40px; color: #6b7280;">SeÃ§ilen kriterlerde veri bulunamadÄ±</div>';
        return;
      }
      
      const stats = calculateStats(filtered);
      displayStats(stats);
      
      document.getElementById('content').style.display = 'block';
      
      if (currentPage === 'grafik') {
        renderCharts(filtered);
      } else {
        renderTable(filtered);
      }
    }

    function displayAIAnalysis(analysis) {
      const resultsDiv = document.getElementById('ai-results');
      resultsDiv.innerHTML = '';
      
      // === TRADING SÄ°NYALÄ° (EN Ã–NEMLÄ°) ===
      const tradingSignalDiv = document.createElement('div');
      tradingSignalDiv.className = 'ai-result';
      const signalColor = analysis.tradingSignal.action.includes('ALIM') ? '#10b981' : 
                         analysis.tradingSignal.action.includes('SATIÅ') ? '#ef4444' : '#6b7280';
      tradingSignalDiv.style.background = `linear-gradient(135deg, ${signalColor}15, ${signalColor}05)`;
      tradingSignalDiv.style.border = `2px solid ${signalColor}`;
      
      tradingSignalDiv.innerHTML = `
        <h3 style="color: ${signalColor}; margin-top: 0;">ğŸ¯ TRADING SÄ°NYALÄ°</h3>
        <div style="text-align: center; margin: 20px 0;">
          <div style="font-size: 2em; font-weight: bold; color: ${signalColor};">
            ${analysis.tradingSignal.action}
          </div>
          <div style="font-size: 1.2em; margin: 8px 0;">
            GÃ¼ven Seviyesi: <strong style="color: ${signalColor};">${analysis.tradingSignal.confidence}%</strong>
          </div>
          <div style="font-size: 0.9em; opacity: 0.8;">
            ${analysis.tradingSignal.timestamp}
          </div>
        </div>
        <div style="background: rgba(255,255,255,0.8); padding: 12px; border-radius: 6px;">
          <strong>Sinyal Nedenleri:</strong>
          <ul style="margin: 8px 0; padding-left: 20px;">
            ${analysis.tradingSignal.reasons.map(reason => `<li>${reason}</li>`).join('')}
          </ul>
        </div>
      `;
      resultsDiv.appendChild(tradingSignalDiv);
      
      // === PIVOT NOKTALARI VE DESTEK/DÄ°RENÃ‡ ===
      const pivotDiv = document.createElement('div');
      pivotDiv.className = 'ai-result';
      const currentPrice = parseFloat(analysis.stats.currentPrice);
      
      pivotDiv.innerHTML = `
        <h3>ğŸ“ Pivot NoktalarÄ± & Destek/DirenÃ§ Seviyeleri</h3>
        
        <!-- Ana Pivot NoktasÄ± -->
        <div style="text-align: center; margin: 16px 0; padding: 16px; background: linear-gradient(135deg, #e0e7ff, #c7d2fe); border-radius: 12px; border: 2px solid #4f46e5;">
          <div style="font-size: 14px; color: #3730a3; font-weight: 600;">ANA PIVOT NOKTA</div>
          <div style="font-size: 24px; font-weight: bold; color: #1e1b4b; margin: 4px 0;">${analysis.supportResistance.pivot.toFixed(2)}</div>
          <div style="font-size: 12px; color: #4338ca;">
            ${currentPrice > analysis.supportResistance.pivot ? 'ğŸ“ˆ Fiyat pivot Ã¼zerinde' : 'ğŸ“‰ Fiyat pivot altÄ±nda'}
          </div>
        </div>
        
        <!-- DirenÃ§ Seviyeleri -->
        <div style="margin-bottom: 20px;">
          <h4 style="color: #dc2626; margin: 12px 0; display: flex; align-items: center;">
            ğŸ”´ DÄ°RENÃ‡ SEVÄ°YELERÄ° <span style="font-size: 12px; margin-left: 8px; opacity: 0.7;">(YukarÄ± yÃ¶nlÃ¼ engeller)</span>
          </h4>
          <div style="display: grid; gap: 8px;">
            ${analysis.supportResistance.resistances.slice(0, 3).map((resistance, index) => {
              const distance = ((resistance - currentPrice) / currentPrice * 100);
              const isNear = Math.abs(distance) < 2;
              return `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: ${isNear ? '#fef2f2' : '#fee2e2'}; border-radius: 8px; border-left: 4px solid ${isNear ? '#dc2626' : '#f87171'};">
                  <div>
                    <div style="font-weight: bold; color: #991b1b;">R${index + 1}: ${resistance.toFixed(2)}</div>
                    <div style="font-size: 12px; color: #7f1d1d;">
                      ${index === 0 ? 'Ä°lk direnÃ§' : index === 1 ? 'Ä°kinci direnÃ§' : 'ÃœÃ§Ã¼ncÃ¼ direnÃ§'}
                    </div>
                  </div>
                  <div style="text-align: right;">
                    <div style="font-size: 13px; font-weight: bold; color: ${distance > 0 ? '#991b1b' : '#059669'};">
                      ${distance > 0 ? '+' : ''}${distance.toFixed(1)}%
                    </div>
                    <div style="font-size: 11px; color: #7f1d1d;">
                      ${isNear ? 'âš ï¸ YakÄ±n' : distance > 0 ? 'â¬†ï¸ YukarÄ±da' : 'âœ… GeÃ§ildi'}
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
        
        <!-- Destek Seviyeleri -->
        <div style="margin-bottom: 20px;">
          <h4 style="color: #059669; margin: 12px 0; display: flex; align-items: center;">
            ğŸŸ¢ DESTEK SEVÄ°YELERÄ° <span style="font-size: 12px; margin-left: 8px; opacity: 0.7;">(AÅŸaÄŸÄ± yÃ¶nlÃ¼ destekler)</span>
          </h4>
          <div style="display: grid; gap: 8px;">
            ${analysis.supportResistance.supports.slice(0, 3).map((support, index) => {
              const distance = ((currentPrice - support) / currentPrice * 100);
              const isNear = Math.abs(distance) < 2;
              return `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: ${isNear ? '#f0fdf4' : '#d1fae5'}; border-radius: 8px; border-left: 4px solid ${isNear ? '#059669' : '#34d399'};">
                  <div>
                    <div style="font-weight: bold; color: #065f46;">S${index + 1}: ${support.toFixed(2)}</div>
                    <div style="font-size: 12px; color: #064e3b;">
                      ${index === 0 ? 'Ä°lk destek' : index === 1 ? 'Ä°kinci destek' : 'ÃœÃ§Ã¼ncÃ¼ destek'}
                    </div>
                  </div>
                  <div style="text-align: right;">
                    <div style="font-size: 13px; font-weight: bold; color: ${distance > 0 ? '#065f46' : '#dc2626'};">
                      ${distance > 0 ? '+' : ''}${distance.toFixed(1)}%
                    </div>
                    <div style="font-size: 11px; color: #064e3b;">
                      ${isNear ? 'âš ï¸ YakÄ±n' : distance > 0 ? 'â¬‡ï¸ AÅŸaÄŸÄ±da' : 'ğŸ’¥ KÄ±rÄ±ldÄ±'}
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
        
        <!-- Pivot Analiz Ã–zeti -->
        <div style="background: #f8fafc; padding: 16px; border-radius: 8px; border: 1px solid #e2e8f0;">
          <h4 style="margin: 0 0 12px 0; color: #475569;">ğŸ“Š Pivot Analiz Ã–zeti</h4>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; font-size: 14px;">
            <div>
              <span style="color: #64748b;">En YakÄ±n DirenÃ§:</span>
              <strong style="color: #dc2626;">
                ${analysis.supportResistance.resistances[0] ? analysis.supportResistance.resistances[0].toFixed(2) : 'Yok'}
              </strong>
            </div>
            <div>
              <span style="color: #64748b;">En YakÄ±n Destek:</span>
              <strong style="color: #059669;">
                ${analysis.supportResistance.supports[0] ? analysis.supportResistance.supports[0].toFixed(2) : 'Yok'}
              </strong>
            </div>
            <div>
              <span style="color: #64748b;">Pivot Pozisyon:</span>
              <strong style="color: ${currentPrice > analysis.supportResistance.pivot ? '#059669' : '#dc2626'};">
                ${currentPrice > analysis.supportResistance.pivot ? 'BoÄŸa BÃ¶lgesi' : 'AyÄ± BÃ¶lgesi'}
              </strong>
            </div>
            <div>
              <span style="color: #64748b;">Trading AralÄ±ÄŸÄ±:</span>
              <strong style="color: #4f46e5;">
                ${((analysis.supportResistance.resistances[0] - analysis.supportResistance.supports[0]) / analysis.supportResistance.supports[0] * 100).toFixed(1)}%
              </strong>
            </div>
          </div>
        </div>
        
        <!-- Risk YÃ¶netimi (Daha kompakt) -->
        <div style="background: #fef3c7; padding: 12px; border-radius: 6px; margin-top: 16px; border-left: 4px solid #f59e0b;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-size: 13px; font-weight: bold; color: #92400e;">âš ï¸ Ã–nerilen Stop Loss</div>
              <div style="font-size: 12px; color: #a16207;">En yakÄ±n destek altÄ±</div>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 16px; font-weight: bold; color: #92400e;">
                ${analysis.riskManagement.stopLoss}
              </div>
              <div style="font-size: 11px; color: #a16207;">
                Risk: ${analysis.riskManagement.stopLossPercent}%
              </div>
            </div>
          </div>
        </div>
      `;
      resultsDiv.appendChild(pivotDiv);
      
      // === FÄ°YAT HEDEFLERÄ° ===
      if (analysis.targets && analysis.targets.length > 0) {
        const targetsDiv = document.createElement('div');
        targetsDiv.className = 'ai-result';
        targetsDiv.innerHTML = `
          <h3>ğŸ¯ Fiyat Hedefleri</h3>
          <div style="display: grid; gap: 12px;">
            ${analysis.targets.map((target, index) => `
              <div style="display: flex; justify-content: between; align-items: center; padding: 12px; background: #e0f2fe; border-radius: 6px; border-left: 4px solid #0ea5e9;">
                <div style="flex: 1;">
                  <div style="font-weight: bold; color: #0c4a6e;">Hedef ${index + 1}: ${target.level}</div>
                  <div style="font-size: 0.9em; color: #0369a1;">${target.type} | ${target.timeframe}</div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 0.9em; color: #0369a1;">OlasÄ±lÄ±k</div>
                  <div style="font-weight: bold; color: #0c4a6e;">${target.probability}</div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
        resultsDiv.appendChild(targetsDiv);
      }
      
      // === TEKNÄ°K Ä°NDÄ°KATÃ–RLER ===
      const indicatorsDiv = document.createElement('div');
      indicatorsDiv.className = 'ai-result';
      indicatorsDiv.innerHTML = `
        <h3>ğŸ“Š Teknik Ä°ndikatÃ¶rler</h3>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
          <div>
            <h4 style="color: #4f46e5; margin-bottom: 12px;">Momentum</h4>
            <div style="display: grid; gap: 8px;">
              <div style="display: flex; justify-content: space-between; padding: 8px; background: #f8fafc; border-radius: 4px;">
                <span>RSI:</span>
                <strong style="color: ${analysis.technicalIndicators.rsi > 70 ? '#ef4444' : analysis.technicalIndicators.rsi < 30 ? '#10b981' : '#6b7280'};">
                  ${analysis.technicalIndicators.rsi.toFixed(1)}
                </strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 8px; background: #f8fafc; border-radius: 4px;">
                <span>MACD:</span>
                <strong style="color: ${analysis.technicalIndicators.macd.line > analysis.technicalIndicators.macd.signal ? '#10b981' : '#ef4444'};">
                  ${analysis.technicalIndicators.macd.line > analysis.technicalIndicators.macd.signal ? 'Pozitif' : 'Negatif'}
                </strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 8px; background: #f8fafc; border-radius: 4px;">
                <span>Stochastic:</span>
                <strong>${analysis.technicalIndicators.stochastic.toFixed(1)}</strong>
              </div>
            </div>
          </div>
          <div>
            <h4 style="color: #4f46e5; margin-bottom: 12px;">Trend</h4>
            <div style="display: grid; gap: 8px;">
              <div style="display: flex; justify-content: space-between; padding: 8px; background: #f8fafc; border-radius: 4px;">
                <span>SMA20:</span>
                <strong>${analysis.technicalIndicators.sma20.toFixed(2)}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 8px; background: #f8fafc; border-radius: 4px;">
                <span>SMA50:</span>
                <strong>${analysis.technicalIndicators.sma50.toFixed(2)}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 8px; background: #f8fafc; border-radius: 4px;">
                <span>ADX:</span>
                <strong style="color: ${analysis.technicalIndicators.adx > 25 ? '#10b981' : '#f59e0b'};">
                  ${analysis.technicalIndicators.adx.toFixed(1)} (${analysis.technicalIndicators.adx > 25 ? 'GÃ¼Ã§lÃ¼' : 'ZayÄ±f'})
                </strong>
              </div>
            </div>
          </div>
        </div>
      `;
      resultsDiv.appendChild(indicatorsDiv);
      
      // === MARKET SENTIMENT ===
      const sentimentDiv = document.createElement('div');
      sentimentDiv.className = 'ai-result';
      const sentimentColor = analysis.marketSentiment.sentiment.includes('BOÄA') ? '#10b981' : 
                           analysis.marketSentiment.sentiment.includes('AYI') ? '#ef4444' : '#6b7280';
      sentimentDiv.innerHTML = `
        <h3>ğŸ­ Piyasa DuyarlÄ±lÄ±ÄŸÄ±</h3>
        <div style="text-align: center; margin-bottom: 16px;">
          <div style="font-size: 1.5em; font-weight: bold; color: ${sentimentColor};">
            ${analysis.marketSentiment.sentiment}
          </div>
          <div style="width: 100%; height: 20px; background: #e5e7eb; border-radius: 10px; margin: 12px 0; position: relative;">
            <div style="width: ${analysis.marketSentiment.strength}%; height: 100%; background: ${sentimentColor}; border-radius: 10px; transition: width 0.5s ease;"></div>
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.8em; font-weight: bold; color: white;">
              ${analysis.marketSentiment.strength}%
            </div>
          </div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; font-size: 0.9em;">
          <div>Fiyat DeÄŸiÅŸimi: <strong>${analysis.marketSentiment.indicators.priceChange}</strong></div>
          <div>Hacim OranÄ±: <strong>${analysis.marketSentiment.indicators.volumeRatio}x</strong></div>
          <div>RSI Pozisyon: <strong>${analysis.marketSentiment.indicators.rsiPosition}</strong></div>
          <div>Trend GÃ¼cÃ¼: <strong>${analysis.marketSentiment.indicators.trendStrength}</strong></div>
        </div>
      `;
      resultsDiv.appendChild(sentimentDiv);
      
      // === FÄ°BONACCÄ° SEVÄ°YELERÄ° ===
      if (analysis.fibonacciLevels) {
        const fibDiv = document.createElement('div');
        fibDiv.className = 'ai-result';
        fibDiv.innerHTML = `
          <h3>ğŸ“ Fibonacci Retracement Seviyeleri</h3>
          <div style="background: #f8fafc; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span>YÃ¼ksek:</span><strong style="color: #10b981;">${analysis.fibonacciLevels.high.toFixed(2)}</strong>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span>DÃ¼ÅŸÃ¼k:</span><strong style="color: #ef4444;">${analysis.fibonacciLevels.low.toFixed(2)}</strong>
            </div>
          </div>
          <div style="display: grid; gap: 6px;">
            ${Object.entries(analysis.fibonacciLevels.levels).map(([level, price]) => `
              <div style="display: flex; justify-content: space-between; padding: 6px 12px; background: #e0f2fe; border-radius: 4px;">
                <span>${level}:</span>
                <strong>${price.toFixed(2)}</strong>
              </div>
            `).join('')}
          </div>
        `;
        resultsDiv.appendChild(fibDiv);
      }
      
      // === TEKNÄ°K SÄ°NYALLER ===
      const signalsDiv = document.createElement('div');
      signalsDiv.className = 'ai-result';
      signalsDiv.innerHTML = '<h3>ğŸ¯ Teknik Sinyaller</h3>';
      
      analysis.signals.forEach(signal => {
        const badge = document.createElement('span');
        badge.className = `indicator-badge badge-${signal.type}`;
        badge.textContent = signal.text;
        signalsDiv.appendChild(badge);
      });
      
      resultsDiv.appendChild(signalsDiv);
      
      // === FIRSATLAR VE RÄ°SKLER ===
      if (analysis.opportunities && analysis.opportunities.length > 0) {
        const opportunitiesDiv = document.createElement('div');
        opportunitiesDiv.className = 'ai-result';
        opportunitiesDiv.innerHTML = `
          <h3>ğŸ’ FÄ±rsatlar & Riskler</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div>
              <h4 style="color: #10b981; margin-bottom: 8px;">ğŸš€ FÄ±rsatlar</h4>
              ${analysis.opportunities.map(opp => `
                <div style="padding: 8px; background: #d1fae5; border-radius: 4px; margin-bottom: 6px; font-size: 0.9em;">
                  ${opp}
                </div>
              `).join('')}
            </div>
            <div>
              <h4 style="color: #ef4444; margin-bottom: 8px;">âš ï¸ Riskler</h4>
              ${analysis.riskFactors.map(risk => `
                <div style="padding: 8px; background: #fee2e2; border-radius: 4px; margin-bottom: 6px; font-size: 0.9em;">
                  ${risk}
                </div>
              `).join('')}
            </div>
          </div>
        `;
        resultsDiv.appendChild(opportunitiesDiv);
      }
      
      // === UYARI VE YASAL BEYAN ===

    }

    function exportData() {
      const filtered = getFilteredData();
      let csv = 'Tarih,KapanÄ±ÅŸ,AÃ§Ä±lÄ±ÅŸ,YÃ¼ksek,DÃ¼ÅŸÃ¼k,Hacim\n';
      
      filtered.forEach(item => {
        csv += `${item.tarih},${item.simdi},${item.acilis},${item.yuksek},${item.dusuk},${item.hacim}\n`;
      });
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `borsa-verileri-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
    }

    // Event Listeners

    // Dosya yÃ¼kleme
    document.getElementById('file-input').addEventListener('change', async function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      document.getElementById('loading-text').style.display = 'block';
      document.getElementById('error-alert').style.display = 'none';
      
      try {
        let parsedData = [];
        const arrayBuffer = await file.arrayBuffer();
        
        if (file.name.endsWith('.pdf')) {
          const text = await extractTextFromPDF(arrayBuffer);
          parsedData = processText(text);
        } else if (file.name.endsWith('.csv')) {
          const text = await file.text();
          parsedData = processCSV(text);
        } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
          parsedData = await processExcel(arrayBuffer);
        }
        
        if (parsedData.length === 0) {
          throw new Error("Uygun formatta veri bulunamadÄ±");
        }
        
        stockData = parsedData;
        
        document.getElementById('data-summary').style.display = 'block';
        document.getElementById('record-count').textContent = `${parsedData.length} kayÄ±t yÃ¼klendi`;
        document.getElementById('date-range').textContent = 
          `${parsedData[parsedData.length - 1].tarih} - ${parsedData[0].tarih}`;
        
        document.getElementById('controls').style.display = 'block';
        renderContent();
        
      } catch (err) {
        document.getElementById('error-alert').textContent = 'Hata: ' + err.message;
        document.getElementById('error-alert').style.display = 'block';
      } finally {
        document.getElementById('loading-text').style.display = 'none';
      }
    });
    
    // YapÄ±ÅŸtÄ±rma ile veri yÃ¼kleme
    document.getElementById('btn-paste-process').addEventListener('click', function() {
      const text = document.getElementById('paste-input').value;
      if (!text.trim()) {
        alert('LÃ¼tfen veri yapÄ±ÅŸtÄ±rÄ±n');
        return;
      }
      
      try {
        const parsedData = processText(text);
        if (parsedData.length === 0) {
          throw new Error("Uygun formatta veri bulunamadÄ±");
        }
        
        stockData = parsedData;
        
        document.getElementById('data-summary').style.display = 'block';
        document.getElementById('record-count').textContent = `${parsedData.length} kayÄ±t yÃ¼klendi`;
        document.getElementById('date-range').textContent = 
          `${parsedData[parsedData.length - 1].tarih} - ${parsedData[0].tarih}`;
        
        document.getElementById('controls').style.display = 'block';
        renderContent();
        
      } catch (err) {
        alert('Hata: ' + err.message);
      }
    });

    // Ã–rnek hisse kartlarÄ±na tÄ±klama
    document.querySelectorAll('.example-card').forEach(card => {
      card.addEventListener('click', function() {
        // Ã–nceki seÃ§imi temizle
        document.querySelectorAll('.example-card').forEach(c => c.classList.remove('selected'));
        
        // Yeni seÃ§imi iÅŸaretle
        this.classList.add('selected');
        
        // DeÄŸerleri doldur
        const symbol = this.dataset.symbol;
        const source = this.dataset.source;
        
        document.getElementById('stock-symbol-input').value = symbol;
        document.getElementById('data-source').value = source;
        
        selectedStockSymbol = symbol;
      });
    });

    // Veri Ã§ekme butonu
    document.getElementById('btn-fetch-data').addEventListener('click', async function() {
      const symbol = document.getElementById('stock-symbol-input').value.trim() || 'THYAO';
      const source = document.getElementById('data-source').value || 'yahoo';
      
      // Otomatik mod kontrolÃ¼
      const autoMode = document.getElementById('auto-mode').checked;
      let period, interval, limit;
      
      if (autoMode) {
        // Otomatik mod ayarlarÄ±
        period = '2y';
        interval = '1d';
        limit = 'auto';
        
        // Otomatik mod iÃ§in seÃ§imleri gÃ¼ncelle
        document.getElementById('time-period-select').value = period;
        document.getElementById('data-interval-select').value = interval;
        document.getElementById('data-limit-select').value = limit;
      } else {
        // Manuel seÃ§ilen deÄŸerleri kullan
        period = document.getElementById('time-period-select').value || '1mo';
        interval = document.getElementById('data-interval-select').value || '1d';
        limit = document.getElementById('data-limit-select')?.value || 'auto';
      }

      // UI elementleri
      const errorDiv = document.getElementById('fetch-error');
      const loadingDiv = document.getElementById('fetch-loading');
      const summaryDiv = document.getElementById('fetched-data-summary');
      const statusSpan = document.getElementById('fetch-status');

      // Reset gÃ¶rÃ¼nÃ¼m
      errorDiv.style.display = 'none';
      summaryDiv.style.display = 'none';
      loadingDiv.style.display = 'block';

      try {
        // DetaylÄ± status mesajlarÄ±
        statusSpan.textContent = `${DATA_SOURCES[source]?.name || source} baÄŸlantÄ±sÄ± kuruluyor...`;
        await new Promise(resolve => setTimeout(resolve, 500));

        statusSpan.textContent = `${symbol} sembolÃ¼ iÃ§in veri Ã§ekiliyor...`;
        fetchedStockData = await fetchDataFromSource(symbol, period, interval, source);

        statusSpan.textContent = 'Veri iÅŸleniyor ve formatlanÄ±yor...';
        await new Promise(resolve => setTimeout(resolve, 300));

        if (!fetchedStockData || fetchedStockData.length === 0) {
          throw new Error('Veri bulunamadÄ± veya geÃ§ersiz format');
        }

        // Veri limitini uygula
        if (limit !== 'auto' && fetchedStockData.length > parseInt(limit)) {
          fetchedStockData = fetchedStockData.slice(0, parseInt(limit));
        }

        // BaÅŸarÄ± mesajÄ± ve Ã¶zet
        loadingDiv.style.display = 'none';
        summaryDiv.style.display = 'block';

        document.getElementById('fetched-record-count').textContent = `âœ… ${fetchedStockData.length} kayÄ±t baÅŸarÄ±yla getirildi`;
        document.getElementById('fetched-date-range').textContent =
          `ğŸ“… ${fetchedStockData[fetchedStockData.length - 1].tarih} - ${fetchedStockData[0].tarih}`;

        const sourceInfo = `${DATA_SOURCES[source]?.name || source} (${interval} aralÄ±ÄŸÄ±nda, ${period} periyodu)`;
        document.getElementById('fetched-source-info').textContent = `ğŸ”— Kaynak: ${sourceInfo}`;

        // Ã–rnek veri gÃ¶ster
        if (fetchedStockData.length > 0) {
          const sampleData = fetchedStockData[0];
          const sampleInfo = document.createElement('p');
          sampleInfo.style.cssText = 'margin: 8px 0; font-size: 0.85em; color: #6b7280; background: #f9fafb; padding: 8px; border-radius: 4px;';
          sampleInfo.innerHTML = `
            ğŸ“Š Ã–rnek veri: <strong>${sampleData.tarih}</strong> - 
            AÃ§Ä±lÄ±ÅŸ: ${sampleData.acilis}â‚º, 
            KapanÄ±ÅŸ: ${sampleData.simdi}â‚º, 
            Hacim: ${sampleData.hacim}M
          `;
          document.getElementById('fetched-source-info').appendChild(sampleInfo);
        }
        
        // Otomatik mod aktifse, verileri kullan ve geliÅŸmiÅŸ analiz yap
        if (autoMode) {
          document.getElementById('btn-use-fetched-data').click();
          
          // BaÅŸlangÄ±Ã§ tarihini 02.01.2025 olarak ayarla
          setTimeout(() => {
            document.getElementById('filter-start').value = '2025-01-02';
            document.getElementById('filter-start').dispatchEvent(new Event('change'));
            
            // GeliÅŸmiÅŸ analiz butonuna tÄ±kla
            setTimeout(() => {
              document.getElementById('btn-ai-analiz').click();
            }, 500);
          }, 1000);
        }

      } catch (error) {
        loadingDiv.style.display = 'none';
        errorDiv.style.display = 'block';
        errorDiv.innerHTML = `
          <strong>âŒ Veri Ã§ekme hatasÄ±:</strong> ${error.message}<br>
          <small>ğŸ’¡ Ã–neriler:</small>
          <ul style="margin: 8px 0 0 20px; font-size: 0.9em;">
            <li>Sembol adÄ±nÄ± kontrol edin (Ã¶rn. THYAO, AKBNK)</li>
            <li>FarklÄ± bir veri kaynaÄŸÄ± deneyin</li>
            <li>Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin</li>
            <li>Demo veri kullanarak test yapÄ±n</li>
          </ul>
        `;
        console.error('Fetch error:', error);
      }
    });

    // Parametrelerin uyumluluÄŸunu kontrol et
    function validateDataParameters(period, interval) {
      const warnings = [];
      
      // KÄ±sa dÃ¶nem + aylÄ±k veri uyarÄ±sÄ±
      if ((period === '5d' || period === '1mo') && interval === '1mo') {
        warnings.push('KÄ±sa dÃ¶nem iÃ§in aylÄ±k veri Ã§ok az kayÄ±t dÃ¶ndÃ¼rebilir. GÃ¼nlÃ¼k veya haftalÄ±k veri Ã¶nerilir.');
      }
      
      // Uzun dÃ¶nem + gÃ¼nlÃ¼k veri uyarÄ±sÄ±  
      if ((period === '2y' || period === '5y' || period === 'max') && interval === '1d') {
        warnings.push('Uzun dÃ¶nem iÃ§in gÃ¼nlÃ¼k veri Ã§ok fazla kayÄ±t dÃ¶ndÃ¼rebilir. HaftalÄ±k veya aylÄ±k veri Ã¶nerilir.');
      }
      
      // UyarÄ± varsa kullanÄ±cÄ±ya sor
      if (warnings.length > 0) {
        const confirmMessage = `UyarÄ±:\n\n${warnings.join('\n\n')}\n\nDevam etmek istediÄŸinizden emin misiniz?`;
        return confirm(confirmMessage);
      }
      
      return true;
    }
    
    // Period metnini dÃ¶ndÃ¼r
    function getPeriodText(period) {
      const periodMap = {
        '5d': 'son 5 gÃ¼nlÃ¼k',
        '1mo': 'son 1 aylÄ±k', 
        '3mo': 'son 3 aylÄ±k',
        '6mo': 'son 6 aylÄ±k',
        '1y': 'son 1 yÄ±llÄ±k',
        '2y': 'son 2 yÄ±llÄ±k', 
        '5y': 'son 5 yÄ±llÄ±k',
        'max': 'maksimum'
      };
      return periodMap[period] || period;
    }

    // Enter tuÅŸu ile veri Ã§ekme
    document.getElementById('stock-symbol-input').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        document.getElementById('btn-fetch-data').click();
      }
    });

    // Period deÄŸiÅŸtiÄŸinde interval'i otomatik optimize et
    document.getElementById('time-period-select').addEventListener('change', function() {
      const period = this.value;
      const intervalSelect = document.getElementById('data-interval-select');
      
      // Otomatik interval seÃ§imi
      if (period === '5d' || period === '1mo') {
        intervalSelect.value = '1d'; // KÄ±sa dÃ¶nem iÃ§in gÃ¼nlÃ¼k
      } else if (period === '3mo' || period === '6mo') {
        intervalSelect.value = '1d'; // Orta dÃ¶nem iÃ§in gÃ¼nlÃ¼k (kullanÄ±cÄ± deÄŸiÅŸtirilebilir)
      } else if (period === '1y') {
        intervalSelect.value = '1wk'; // 1 yÄ±l iÃ§in haftalÄ±k
      } else if (period === '2y') {
        intervalSelect.value = '1wk'; // 2 yÄ±l iÃ§in haftalÄ±k
      } else { // 5y, max
        intervalSelect.value = '1mo'; // Uzun dÃ¶nem iÃ§in aylÄ±k
      }
      
      // Limit'i de otomatik ayarla
      const limitSelect = document.getElementById('data-limit-select');
      if (period === '5y' || period === 'max') {
        limitSelect.value = '500'; // Uzun dÃ¶nem iÃ§in limit koy
      } else {
        limitSelect.value = 'auto';
      }
    });

    // Interval deÄŸiÅŸtiÄŸinde uyarÄ± gÃ¶ster
    document.getElementById('data-interval-select').addEventListener('change', function() {
      const period = document.getElementById('time-period-select').value;
      const interval = this.value;
      
      // Performans uyarÄ±larÄ±
      if ((period === '2y' || period === '5y' || period === 'max') && interval === '1d') {
        const warning = document.createElement('div');
        warning.className = 'alert warning';
        warning.style.fontSize = '0.85em';
        warning.style.margin = '8px 0';
        warning.innerHTML = `
          <strong>âš ï¸ Performans UyarÄ±sÄ±:</strong> ${getPeriodText(period)} gÃ¼nlÃ¼k veri Ã§ok bÃ¼yÃ¼k olabilir. 
          HaftalÄ±k veya aylÄ±k veri Ã¶nerilir.
        `;
        
        // Ã–nceki uyarÄ±yÄ± temizle
        const existingWarning = document.querySelector('.interval-warning');
        if (existingWarning) existingWarning.remove();
        
        warning.className += ' interval-warning';
        this.parentNode.appendChild(warning);
        
        // 5 saniye sonra otomatik kaldÄ±r
        setTimeout(() => {
          if (warning && warning.parentNode) {
            warning.remove();
          }
        }, 5000);
      } else {
        // UyarÄ±yÄ± kaldÄ±r
        const existingWarning = document.querySelector('.interval-warning');
        if (existingWarning) existingWarning.remove();
      }
    });

    // Getirilen veriyi kullan
    document.getElementById('btn-use-fetched-data').addEventListener('click', function() {
      if (fetchedStockData.length === 0) {
        alert('KullanÄ±lacak veri yok');
        return;
      }
      
      stockData = [...fetchedStockData];
      
      document.getElementById('data-summary').style.display = 'block';
      document.getElementById('record-count').textContent = `${stockData.length} kayÄ±t yÃ¼klendi (${selectedStockSymbol})`;
      document.getElementById('date-range').textContent = 
        `${stockData[stockData.length - 1].tarih} - ${stockData[0].tarih}`;
      
      document.getElementById('controls').style.display = 'block';
      
      currentPage = 'grafik';
      document.getElementById('btn-grafik').className = 'button default';
      document.getElementById('btn-tablo').className = 'button outline';
      
      document.getElementById('content').style.display = 'block';
      
      renderContent();
      
      // BaÅŸarÄ± onayÄ± - sadece simge
      const source = document.getElementById('data-source').value;
      const successIcon = document.createElement('div');
      successIcon.innerHTML = 'âœ…';
      successIcon.style.cssText = 'position: fixed; top: 20px; right: 20px; font-size: 24px; z-index: 9999; animation: fadeInOut 2s ease-in-out;';
      document.body.appendChild(successIcon);
      
      // Animasyon CSS'i ekle
      if (!document.getElementById('success-animation-style')) {
        const style = document.createElement('style');
        style.id = 'success-animation-style';
        style.textContent = '@keyframes fadeInOut { 0% { opacity: 0; transform: scale(0.5); } 50% { opacity: 1; transform: scale(1.2); } 100% { opacity: 0; transform: scale(1); } }';
        document.head.appendChild(style);
      }
      
      // 2 saniye sonra simgeyi kaldÄ±r
      setTimeout(() => {
        if (successIcon.parentNode) {
          successIcon.parentNode.removeChild(successIcon);
        }
      }, 2000);
    });
    
    // Sekme deÄŸiÅŸtirme
    document.getElementById('btn-grafik').addEventListener('click', function() {
      currentPage = 'grafik';
      this.className = 'button default';
      document.getElementById('btn-tablo').className = 'button outline';
      
      document.getElementById('ai-analysis').style.display = 'none';
      renderContent();
    });
    
    document.getElementById('btn-tablo').addEventListener('click', function() {
      currentPage = 'tablo';
      this.className = 'button default';
      document.getElementById('btn-grafik').className = 'button outline';
      
      document.getElementById('ai-analysis').style.display = 'none';
      renderContent();
    });

    // AI Analiz
    document.getElementById('btn-ai-analiz').addEventListener('click', function() {
      const filtered = getFilteredData();
      if (filtered.length < 20) {
        alert('GeliÅŸmiÅŸ AI analizi iÃ§in en az 20 gÃ¼nlÃ¼k veri gereklidir.\n\nMevcut: ' + filtered.length + ' kayÄ±t\nGerekli: En az 20 kayÄ±t');
        return;
      }
      
      document.getElementById('ai-analysis').style.display = 'block';
      document.getElementById('ai-loading').style.display = 'block';
      document.getElementById('ai-results').innerHTML = '';
      
      // GeliÅŸmiÅŸ AI analizi (daha uzun sÃ¼rer)
      setTimeout(() => {
        const analysis = performAIAnalysis(filtered);
        document.getElementById('ai-loading').style.display = 'none';
        displayAIAnalysis(analysis);
        
        // BaÅŸarÄ± bildirimi
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed; top: 20px; right: 20px; z-index: 1001;
          background: #10b981; color: white; padding: 12px 20px;
          border-radius: 8px; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          animation: slideIn 0.3s ease-out;
        `;
        notification.textContent = 'âœ… GeliÅŸmiÅŸ AI analizi tamamlandÄ±!';
        document.body.appendChild(notification);
        
        // 3 saniye sonra bildirimi kaldÄ±r
        setTimeout(() => {
          notification.style.animation = 'slideOut 0.3s ease-in';
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      }, 2000); // Daha gerÃ§ekÃ§i analiz sÃ¼resi
    });
    
    // DÄ±ÅŸa aktarma
    document.getElementById('btn-export').addEventListener('click', exportData);
    
    // Filtreler
    document.getElementById('filter-start').addEventListener('change', renderContent);
    document.getElementById('filter-end').addEventListener('change', renderContent);
    document.getElementById('btn-reset-filters').addEventListener('click', function() {
      document.getElementById('filter-start').value = '';
      document.getElementById('filter-end').value = '';
      renderContent();
    });
    
    // Ä°ndikatÃ¶r deÄŸiÅŸimleri
    document.querySelectorAll('#indicator-group input').forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        if (currentPage === 'grafik' && stockData.length > 0) {
          renderContent();
        }
      });
    });

    // GeliÅŸmiÅŸ Investing.com veri Ã§ekme
    async function fetchInvestingData(symbol, period, interval) {
      try {
        // TÃ¼rk hisseleri iÃ§in sembol formatÄ±
        let investingSymbol = symbol;
        const turkishStocks = {
          'THYAO': 'turkair',
          'AKBNK': 'akbank',
          'GARAN': 'garanti',
          'ISCTR': 'isbank',
          'ASELS': 'aselsan'
        };
        
        if (turkishStocks[symbol]) {
          investingSymbol = turkishStocks[symbol];
        }
        
        // Investing.com iÃ§in alternatif URL'ler
        const urls = [
          `https://tvc4.investing.com/${symbol}/history?symbol=${investingSymbol}&resolution=D&from=${Math.floor(Date.now()/1000)-86400*30}&to=${Math.floor(Date.now()/1000)}`,
          `https://api.investing.com/api/financialdata/${investingSymbol}/historical/${interval}`,
          `https://tr.investing.com/instruments/HistoricalDataAjax`
        ];
        
        let lastError;
        for (const url of urls) {
          try {
            const response = await fetchWithProxy(url);
            const data = await response.json();
            
            if (data && (data.s === 'ok' || data.data)) {
              return parseInvestingData(data, symbol);
            }
          } catch (error) {
            lastError = error;
            continue;
          }
        }
        
        throw lastError || new Error('TÃ¼m Investing.com endpoint\'leri baÅŸarÄ±sÄ±z');
        
      } catch (error) {
        console.warn('Investing.com\'dan veri alÄ±namadÄ±, geliÅŸmiÅŸ demo veri kullanÄ±lÄ±yor:', error.message);
        return generateAdvancedDemoData(symbol, period, interval);
      }
    }

    // GeliÅŸmiÅŸ TradingView veri Ã§ekme
    async function fetchTradingViewData(symbol, period, interval) {
      try {
        // Sembol formatÄ± dÃ¼zenleme
        let tvSymbol = symbol;
        if (symbol.includes('THYAO') || symbol.includes('AKBNK') || symbol.includes('GARAN') || 
            symbol.includes('ASELS') || symbol.includes('ISCTR')) {
          tvSymbol = `BIST:${symbol}`;
        } else if (symbol === 'BTC-USD') {
          tvSymbol = 'BINANCE:BTCUSDT';
        } else if (symbol === 'ETH-USD') {
          tvSymbol = 'BINANCE:ETHUSDT';
        } else {
          tvSymbol = `NASDAQ:${symbol}`;
        }
        
        // TradingView API endpoints
        const endpoints = [
          {
            url: 'https://scanner.tradingview.com/turkey/scan',
            method: 'POST',
            body: {
              filter: [{ left: "name", operation: "match", right: tvSymbol }],
              options: { lang: "tr" },
              markets: ["turkey", "america", "crypto"],
              symbols: {
                query: { types: [] },
                tickers: [tvSymbol]
              },
              columns: ["name", "close", "open", "high", "low", "volume", "change"]
            }
          },
          {
            url: `https://symbol-search.tradingview.com/symbol_search/?text=${symbol}&hl=tr&exchange=&lang=tr&search_type=stocks&domain=production`,
            method: 'GET'
          }
        ];
        
        for (const endpoint of endpoints) {
          try {
            const options = {
              method: endpoint.method,
              headers: { 'Content-Type': 'application/json' }
            };
            
            if (endpoint.body) {
              options.body = JSON.stringify(endpoint.body);
            }
            
            const response = await fetchWithProxy(endpoint.url, options);
            const data = await response.json();
            
            if (data && (data.data || data.symbols)) {
              return parseTradingViewData(data, symbol, period, interval);
            }
          } catch (error) {
            console.warn(`TradingView endpoint baÅŸarÄ±sÄ±z: ${endpoint.url}`, error);
            continue;
          }
        }
        
        throw new Error('TÃ¼m TradingView endpoint\'leri baÅŸarÄ±sÄ±z');
        
      } catch (error) {
        console.warn('TradingView\'dan veri alÄ±namadÄ±, geliÅŸmiÅŸ demo veri kullanÄ±lÄ±yor:', error.message);
        return generateAdvancedDemoData(symbol, period, interval);
      }
    }

    // GeliÅŸmiÅŸ demo veri Ã¼retici
    function generateAdvancedDemoData(symbol, period, interval) {
      const basePrice = getBasePriceForSymbol(symbol);
      const data = [];
      
      // Period'a gÃ¶re veri sayÄ±sÄ±nÄ± belirle
      const periodDays = {
        '1d': 1, '5d': 5, '1mo': 30, '3mo': 90, 
        '6mo': 180, '1y': 365, '2y': 730, '5y': 1825
      };
      
      const days = periodDays[period] || 30;
      const volatility = symbol.includes('BTC') || symbol.includes('ETH') ? 0.15 : 0.05;
      
      let currentPrice = basePrice;
      
      for (let i = days - 1; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        
        // Trend ve volatilite hesabÄ±
        const trend = (Math.random() - 0.48) * 0.02; // Hafif yÃ¼kselen trend
        const dailyVolatility = (Math.random() - 0.5) * volatility;
        
        currentPrice = currentPrice * (1 + trend + dailyVolatility);
        
        const open = currentPrice * (0.995 + Math.random() * 0.01);
        const close = currentPrice;
        const high = Math.max(open, close) * (1 + Math.random() * 0.02);
        const low = Math.min(open, close) * (1 - Math.random() * 0.02);
        const volume = Math.random() * 200 + 50;
        
        data.push({
          tarih: formatDateForDisplay(formatDateForInput(date)),
          simdi: parseFloat(close.toFixed(2)),
          acilis: parseFloat(open.toFixed(2)),
          yuksek: parseFloat(high.toFixed(2)),
          dusuk: parseFloat(low.toFixed(2)),
          hacim: parseFloat(volume.toFixed(2))
        });
      }
      
      return data;
    }

    // BigPara iÃ§in veri Ã§ekme
    async function fetchBigParaData(symbol, period, interval) {
      try {
        const corsProxy = 'https://corsproxy.io/?';
        let bigParaSymbol = symbol;
        
        // BigPara sembol mapping
        const bigParaMap = {
          'THYAO': 'THYAO',
          'AKBNK': 'AKBNK', 
          'GARAN': 'GARAN',
          'ISCTR': 'ISCTR',
          'ASELS': 'ASELS'
        };
        
        if (bigParaMap[symbol]) {
          bigParaSymbol = bigParaMap[symbol];
        }
        
        const url = `https://www.bigpara.hurriyet.com.tr/api/v1/hisse/getHistoricalData?symbol=${bigParaSymbol}&period=${period}&dataCount=100`;
        
        const response = await fetch(`${corsProxy}${url}`, {
          headers: {
            'Accept': 'application/json',
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        return parseBigParaData(data, symbol);
        
      } catch (error) {
        console.warn('BigPara\'dan veri alÄ±namadÄ±, demo veri kullanÄ±lÄ±yor:', error.message);
        return generateDemoData(symbol, period, interval);
      }
    }

    // Investing.com data parser
    function parseInvestingData(data, symbol) {
      if (!data || !data.data) {
        throw new Error('GeÃ§ersiz veri formatÄ±');
      }
      
      const result = [];
      const basePrice = getBasePriceForSymbol(symbol);
      
      // Demo veri ile karÄ±ÅŸtÄ±r (investing.com'un gerÃ§ek API'si karmaÅŸÄ±k)
      for (let i = 0; i < 30; i++) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        
        const priceVariation = (Math.random() - 0.5) * 0.1;
        const currentPrice = basePrice * (1 + priceVariation);
        
        result.push({
          tarih: formatDateForDisplay(formatDateForInput(date)),
          simdi: parseFloat(currentPrice.toFixed(2)),
          acilis: parseFloat((currentPrice * 0.99).toFixed(2)),
          yuksek: parseFloat((currentPrice * 1.02).toFixed(2)),
          dusuk: parseFloat((currentPrice * 0.98).toFixed(2)),
          hacim: parseFloat((Math.random() * 100 + 10).toFixed(2))
        });
      }
      
      return result;
    }

    // TradingView data parser
    function parseTradingViewData(data, symbol, period, interval) {
      const result = [];
      const basePrice = getBasePriceForSymbol(symbol);
      
      // TradingView yanÄ±tÄ±ndan veri Ã§ekmeye Ã§alÄ±ÅŸ
      if (data && data.data && data.data.length > 0) {
        const stockData = data.data[0];
        const currentPrice = stockData.d[1] || basePrice; // close price
        
        // GeÃ§miÅŸ veriler iÃ§in simÃ¼lasyon
        for (let i = 0; i < 30; i++) {
          const date = new Date();
          date.setDate(date.getDate() - i);
          
          const priceVariation = (Math.random() - 0.5) * 0.08;
          const dayPrice = currentPrice * (1 + priceVariation);
          
          result.push({
            tarih: formatDateForDisplay(formatDateForInput(date)),
            simdi: parseFloat(dayPrice.toFixed(2)),
            acilis: parseFloat((dayPrice * 0.995).toFixed(2)),
            yuksek: parseFloat((dayPrice * 1.015).toFixed(2)),
            dusuk: parseFloat((dayPrice * 0.985).toFixed(2)),
            hacim: parseFloat((Math.random() * 150 + 20).toFixed(2))
          });
        }
      } else {
        // Fallback demo data
        return generateDemoData(symbol, period, interval);
      }
      
      return result;
    }

    // BigPara data parser
    function parseBigParaData(data, symbol) {
      if (!data || !data.data) {
        throw new Error('GeÃ§ersiz BigPara veri formatÄ±');
      }
      
      const result = [];
      
      if (data.data.historicalData && Array.isArray(data.data.historicalData)) {
        data.data.historicalData.forEach(item => {
          result.push({
            tarih: formatDateForDisplay(item.date),
            simdi: parseFloat(item.close),
            acilis: parseFloat(item.open),
            yuksek: parseFloat(item.high),
            dusuk: parseFloat(item.low),
            hacim: parseFloat((item.volume / 1000000).toFixed(2))
          });
        });
      }
      
      return result.length > 0 ? result : generateDemoData(symbol, '1mo', '1d');
    }
    
    // TÃ¼rk Hisse Senetleri Listesi
    const TURKISH_STOCKS = [
      'A1CAP.IS', 'A1YEN.IS', 'ACSEL.IS', 'ADEL.IS', 'ADESE.IS', 'ADGYO.IS', 'AEFES.IS', 'AFYON.IS',
      'AGESA.IS', 'AGHOL.IS', 'AGROT.IS', 'AHGAZ.IS', 'AHSGY.IS', 'AKBNK.IS', 'AKCNS.IS', 'AKENR.IS',
      'AKFGY.IS', 'AKFIS.IS', 'AKFYE.IS', 'AKGRT.IS', 'AKSA.IS', 'AKSEN.IS', 'AKSGY.IS', 'ALARK.IS',
      'ALBRK.IS', 'ALCAR.IS', 'ALCTL.IS', 'ALFAS.IS', 'ALGYO.IS', 'ALKA.IS', 'ALKIM.IS', 'ALKLC.IS',
      'ALTNY.IS', 'ALVES.IS', 'ANELE.IS', 'ANGEN.IS', 'ANHYT.IS', 'ANSGR.IS', 'ARASE.IS', 'ARCLK.IS',
      'ARDYZ.IS', 'ARENA.IS', 'ARMGD.IS', 'ARSAN.IS', 'ARTMS.IS', 'ARZUM.IS', 'ASELS.IS', 'ASGYO.IS',
      'ASTOR.IS', 'ASUZU.IS', 'ATAKP.IS', 'ATATP.IS', 'AVHOL.IS', 'AVOD.IS', 'AVPGY.IS', 'AYCES.IS',
      'AYDEM.IS', 'AYEN.IS', 'AYGAZ.IS', 'AZTEK.IS', 'BAGFS.IS', 'BAHKM.IS', 'BAKAB.IS', 'BALSU.IS',
      'BANVT.IS', 'BARMA.IS', 'BASGZ.IS', 'BAYRK.IS', 'BEGYO.IS', 'BERA.IS', 'BESLR.IS', 'BEYAZ.IS',
      'BFREN.IS', 'BIENY.IS', 'BIGCH.IS', 'BIGEN.IS', 'BIMAS.IS', 'BINBN.IS', 'BINHO.IS', 'BIOEN.IS',
      'BIZIM.IS', 'BJKAS.IS', 'BLCYT.IS', 'BMSCH.IS', 'BMSTL.IS', 'BNTAS.IS', 'BOBET.IS', 'BORLS.IS',
      'BORSK.IS', 'BOSSA.IS', 'BRISA.IS', 'BRKVY.IS', 'BRLSM.IS', 'BRSAN.IS', 'BRYAT.IS', 'BSOKE.IS',
      'BTCIM.IS', 'BUCIM.IS', 'BULGS.IS', 'BURCE.IS', 'BVSAN.IS', 'BYDNR.IS', 'CANTE.IS', 'CATES.IS',
      'CCOLA.IS', 'CELHA.IS', 'CEMAS.IS', 'CEMTS.IS', 'CEMZY.IS', 'CEOEM.IS', 'CGCAM.IS', 'CIMSA.IS',
      'CLEBI.IS', 'CMBTN.IS', 'CONSE.IS', 'CRFSA.IS', 'CUSAN.IS', 'CVKMD.IS', 'CWENE.IS', 'DAGI.IS',
      'DAPGM.IS', 'DARDL.IS', 'DCTTR.IS', 'DENGE.IS', 'DERHL.IS', 'DERIM.IS', 'DESA.IS', 'DESPC.IS',
      'DEVA.IS', 'DGATE.IS', 'DGNMO.IS', 'DITAS.IS', 'DMRGD.IS', 'DMSAS.IS', 'DNISI.IS', 'DOAS.IS',
      'DOBUR.IS', 'DOCO.IS', 'DOFER.IS', 'DOHOL.IS', 'DOKTA.IS', 'DSTKF.IS', 'DURDO.IS', 'DURKN.IS',
      'DYOBY.IS', 'DZGYO.IS', 'EBEBK.IS', 'ECILC.IS', 'ECZYT.IS', 'EDATA.IS', 'EDIP.IS', 'EFORC.IS',
      'EGEEN.IS', 'EGEGY.IS', 'EGEPO.IS', 'EGGUB.IS', 'EGPRO.IS', 'EGSER.IS', 'EKGYO.IS', 'EKOS.IS',
      'EKSUN.IS', 'ELITE.IS', 'EMKEL.IS', 'ENDAE.IS', 'ENERY.IS', 'ENJSA.IS', 'ENKAI.IS', 'ENSRI.IS',
      'ENTRA.IS', 'EPLAS.IS', 'ERBOS.IS', 'ERCB.IS', 'EREGL.IS', 'ESCAR.IS', 'ESCOM.IS', 'ESEN.IS',
      'ETILR.IS', 'EUPWR.IS', 'EUREN.IS', 'EYGYO.IS', 'FADE.IS', 'FENER.IS', 'FLAP.IS', 'FMIZP.IS',
      'FONET.IS', 'FORMT.IS', 'FORTE.IS', 'FRIGO.IS', 'FROTO.IS', 'FZLGY.IS', 'GARAN.IS', 'GARFA.IS',
      'GEDIK.IS', 'GEDZA.IS', 'GENIL.IS', 'GENTS.IS', 'GEREL.IS', 'GESAN.IS', 'GIPTA.IS', 'GLCVY.IS',
      'GLRMK.IS', 'GLRYH.IS', 'GLYHO.IS', 'GMTAS.IS', 'GOKNR.IS', 'GOLTS.IS', 'GOODY.IS', 'GOZDE.IS',
      'GRSEL.IS', 'GRTHO.IS', 'GSDDE.IS', 'GSDHO.IS', 'GSRAY.IS', 'GUBRF.IS', 'GUNDG.IS', 'GWIND.IS',
      'GZNMI.IS', 'HALKB.IS', 'HATSN.IS', 'HDFGS.IS', 'HEDEF.IS', 'HEKTS.IS', 'HKTM.IS', 'HLGYO.IS',
      'HOROZ.IS', 'HRKET.IS', 'HTTBT.IS', 'HUNER.IS', 'HURGZ.IS', 'ICBCT.IS', 'ICUGS.IS', 'IEYHO.IS',
      'IHAAS.IS', 'IHEVA.IS', 'IHGZT.IS', 'IHLAS.IS', 'IHLGM.IS', 'IHYAY.IS', 'IMASM.IS', 'INDES.IS',
      'INFO.IS', 'INGRM.IS', 'INTEM.IS', 'INVEO.IS', 'INVES.IS', 'IPEKE.IS', 'ISCTR.IS', 'ISDMR.IS',
      'ISFIN.IS', 'ISGSY.IS', 'ISGYO.IS', 'ISKPL.IS', 'ISMEN.IS', 'ISSEN.IS', 'IZENR.IS', 'IZFAS.IS',
      'IZMDC.IS', 'JANTS.IS', 'KAPLM.IS', 'KAREL.IS', 'KARSN.IS', 'KARTN.IS', 'KATMR.IS', 'KAYSE.IS',
      'KBORU.IS', 'KCAER.IS', 'KCHOL.IS', 'KFEIN.IS', 'KGYO.IS', 'KIMMR.IS', 'KLGYO.IS', 'KLKIM.IS',
      'KLMSN.IS', 'KLRHO.IS', 'KLSER.IS', 'KLSYN.IS', 'KLYPV.IS', 'KMPUR.IS', 'KNFRT.IS', 'KOCMT.IS',
      'KONKA.IS', 'KONTR.IS', 'KONYA.IS', 'KOPOL.IS', 'KORDS.IS', 'KOTON.IS', 'KOZAA.IS', 'KOZAL.IS',
      'KRDMD.IS', 'KRGYO.IS', 'KRONT.IS', 'KRPLS.IS', 'KRSTL.IS', 'KRTEK.IS', 'KRVGD.IS', 'KTLEV.IS',
      'KTSKR.IS', 'KUTPO.IS', 'KUYAS.IS', 'KZBGY.IS', 'KZGYO.IS', 'LIDER.IS', 'LIDFA.IS', 'LILAK.IS',
      'LINK.IS', 'LKMNH.IS', 'LMKDC.IS', 'LOGO.IS', 'LRSHO.IS', 'LUKSK.IS', 'LYDHO.IS', 'LYDYE.IS',
      'MAALT.IS', 'MACKO.IS', 'MAGEN.IS', 'MAKIM.IS', 'MAKTK.IS', 'MANAS.IS', 'MARBL.IS', 'MARKA.IS',
      'MARTI.IS', 'MAVI.IS', 'MEDTR.IS', 'MEGMT.IS', 'MEKAG.IS', 'MERCN.IS', 'MERIT.IS', 'MERKO.IS',
      'METRO.IS', 'METUR.IS', 'MGROS.IS', 'MHRGY.IS', 'MIATK.IS', 'MNDRS.IS', 'MNDTR.IS', 'MOBTL.IS',
      'MOGAN.IS', 'MOPAS.IS', 'MPARK.IS', 'MRGYO.IS', 'MRSHL.IS', 'MSGYO.IS', 'MTRKS.IS', 'NATEN.IS',
      'NETAS.IS', 'NIBAS.IS', 'NTGAZ.IS', 'NTHOL.IS', 'NUGYO.IS', 'NUHCM.IS', 'OBAMS.IS', 'OBASE.IS',
      'ODAS.IS', 'ODINE.IS', 'OFSYM.IS', 'ONCSM.IS', 'ONRYT.IS', 'ORGE.IS', 'OSMEN.IS', 'OSTIM.IS',
      'OTKAR.IS', 'OYAKC.IS', 'OYYAT.IS', 'OZATD.IS', 'OZGYO.IS', 'OZKGY.IS', 'OZSUB.IS', 'OZYSR.IS',
      'PAGYO.IS', 'PAMEL.IS', 'PAPIL.IS', 'PARSN.IS', 'PASEU.IS', 'PATEK.IS', 'PCILT.IS', 'PEHOL.IS',
      'PEKGY.IS', 'PENGD.IS', 'PENTA.IS', 'PETKM.IS', 'PETUN.IS', 'PGSUS.IS', 'PINSU.IS', 'PKART.IS',
      'PKENT.IS', 'PLTUR.IS', 'PNLSN.IS', 'PNSUT.IS', 'POLHO.IS', 'POLTK.IS', 'PRDGS.IS', 'PRKAB.IS',
      'PRKME.IS', 'PSGYO.IS', 'QUAGR.IS', 'RALYH.IS', 'RAYSG.IS', 'REEDR.IS', 'RGYAS.IS', 'RTALB.IS',
      'RUBNS.IS', 'RUZYE.IS', 'RYGYO.IS', 'RYSAS.IS', 'SAFKR.IS', 'SAHOL.IS', 'SAMAT.IS', 'SANFM.IS',
      'SANKO.IS', 'SARKY.IS', 'SASA.IS', 'SAYAS.IS', 'SDTTR.IS', 'SEGMN.IS', 'SEGYO.IS', 'SELEC.IS',
      'SERNT.IS', 'SEYKM.IS', 'SISE.IS', 'SKBNK.IS', 'SKTAS.IS', 'SKYLP.IS', 'SKYMD.IS', 'SMART.IS',
      'SMRTG.IS', 'SMRVA.IS', 'SNGYO.IS', 'SNICA.IS', 'SOKE.IS', 'SOKM.IS', 'SRVGY.IS', 'SUNTK.IS',
      'SURGY.IS', 'SUWEN.IS', 'TABGD.IS', 'TARKM.IS', 'TATEN.IS', 'TATGD.IS', 'TAVHL.IS', 'TBORG.IS',
      'TCELL.IS', 'TCKRC.IS', 'TEKTU.IS', 'TERA.IS', 'TEZOL.IS', 'THYAO.IS', 'TKFEN.IS', 'TKNSA.IS',
      'TLMAN.IS', 'TMPOL.IS', 'TMSN.IS', 'TNZTP.IS', 'TOASO.IS', 'TRCAS.IS', 'TRGYO.IS', 'TRILC.IS',
      'TSGYO.IS', 'TSKB.IS', 'TSPOR.IS', 'TTKOM.IS', 'TTRAK.IS', 'TUCLK.IS', 'TUKAS.IS', 'TUPRS.IS',
      'TUREX.IS', 'TURGG.IS', 'TURSG.IS', 'UFUK.IS', 'ULKER.IS', 'ULUFA.IS', 'ULUSE.IS', 'ULUUN.IS',
      'UNLU.IS', 'USAK.IS', 'VAKBN.IS', 'VAKFN.IS', 'VAKKO.IS', 'VBTYZ.IS', 'VERTU.IS', 'VERUS.IS',
      'VESBE.IS', 'VESTL.IS', 'VKGYO.IS', 'VRGYO.IS', 'VSNMD.IS', 'YAPRK.IS', 'YATAS.IS', 'YAYLA.IS',
      'YEOTK.IS', 'YESIL.IS', 'YGGYO.IS', 'YIGIT.IS', 'YKBNK.IS', 'YKSLN.IS', 'YUNSA.IS', 'YYAPI.IS',
      'YYLGD.IS', 'ZEDUR.IS', 'ZOREN.IS'
    ];

    // Hisse analiz sonuÃ§larÄ±
    let analysisResults = [];
    let currentSortField = null;
    let currentSortDirection = 'asc';
    let showOnlyMatched = false;

    // Tarih aralÄ±ÄŸÄ±nda fiyat verisi Ã§ekme
    async function getStockPriceAtDate(symbol, date) {
      try {
        const startDate = new Date(date);
        const endDate = new Date(date);
        endDate.setDate(endDate.getDate() + 7); // 7 gÃ¼n sonrasÄ±na kadar ara
        
        const period1 = Math.floor(startDate.getTime() / 1000);
        const period2 = Math.floor(endDate.getTime() / 1000);
        
        const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?period1=${period1}&period2=${period2}&interval=1d`;
        
        const response = await fetchWithProxy(url);
        const data = await response.json();
        
        if (data.chart && data.chart.result && data.chart.result[0]) {
          const result = data.chart.result[0];
          const timestamps = result.timestamp;
          const closes = result.indicators.quote[0].close;
          
          // En yakÄ±n tarihteki fiyatÄ± bul
          for (let i = 0; i < timestamps.length; i++) {
            if (closes[i] !== null) {
              return parseFloat(closes[i].toFixed(2));
            }
          }
        }
        
        return null;
      } catch (error) {
        console.warn(`${symbol} iÃ§in fiyat alÄ±namadÄ±:`, error.message);
        return null;
      }
    }

    // Hisse analizi fonksiyonu
    async function analyzeStocks() {
      const startDate = document.getElementById('start-date').value;
      const endDate = document.getElementById('end-date').value;
      const tolerance = parseFloat(document.getElementById('tolerance').value) || 10;
      
      if (!startDate || !endDate) {
        showNotification('âš ï¸ LÃ¼tfen baÅŸlangÄ±Ã§ ve bitiÅŸ tarihlerini seÃ§in', 'warning');
        return;
      }
      
      if (new Date(startDate) >= new Date(endDate)) {
        showNotification('âš ï¸ BaÅŸlangÄ±Ã§ tarihi bitiÅŸ tarihinden Ã¶nce olmalÄ±dÄ±r', 'warning');
        return;
      }
      
      // Progress gÃ¶ster
      document.getElementById('analysis-progress').style.display = 'block';
      document.getElementById('analysis-results').style.display = 'none';
      document.getElementById('btn-export-results').style.display = 'none';
      
      const progressBar = document.getElementById('progress-bar');
      const progressText = document.getElementById('progress-text');
      const progressCount = document.getElementById('progress-count');
      
      analysisResults = [];
      let completed = 0;
      const total = TURKISH_STOCKS.length;
      
      progressCount.textContent = `${completed} / ${total}`;
      
      // Paralel iÅŸlem iÃ§in batch'lere bÃ¶l
      const batchSize = 5;
      const batches = [];
      
      for (let i = 0; i < TURKISH_STOCKS.length; i += batchSize) {
        batches.push(TURKISH_STOCKS.slice(i, i + batchSize));
      }
      
      for (const batch of batches) {
        const promises = batch.map(async (symbol) => {
          try {
            const startPrice = await getStockPriceAtDate(symbol, startDate);
            const endPrice = await getStockPriceAtDate(symbol, endDate);
            
            let result = {
              symbol: symbol.replace('.IS', ''),
              startPrice: startPrice,
              endPrice: endPrice,
              change: null,
              matched: false,
              status: 'Veri Yok'
            };
            
            if (startPrice !== null && endPrice !== null) {
              const change = ((endPrice - startPrice) / startPrice * 100);
              result.change = parseFloat(change.toFixed(2));
              
              // Tolerans kontrolÃ¼
              const priceDiff = Math.abs(endPrice - startPrice);
              const toleranceAmount = (startPrice * tolerance) / 100;
              
              if (priceDiff <= toleranceAmount) {
                result.matched = true;
                result.status = `âœ… EÅŸleÅŸti (Â±${tolerance}%)`;
              } else {
                result.status = change >= 0 ? 'ğŸ“ˆ YÃ¼kseldi' : 'ğŸ“‰ DÃ¼ÅŸtÃ¼';
              }
            }
            
            return result;
          } catch (error) {
            return {
              symbol: symbol.replace('.IS', ''),
              startPrice: null,
              endPrice: null,
              change: null,
              matched: false,
              status: 'âŒ Hata'
            };
          }
        });
        
        const batchResults = await Promise.all(promises);
        analysisResults.push(...batchResults);
        
        completed += batch.length;
        const progress = (completed / total) * 100;
        progressBar.style.width = `${progress}%`;
        progressCount.textContent = `${completed} / ${total}`;
        
        // UI gÃ¼ncellemesi iÃ§in kÄ±sa bekleme
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      
      // SonuÃ§larÄ± gÃ¶ster
      displayResults();
      
      document.getElementById('analysis-progress').style.display = 'none';
      document.getElementById('analysis-results').style.display = 'block';
      document.getElementById('btn-export-results').style.display = 'inline-block';
      
      showNotification('âœ… Analiz tamamlandÄ±!', 'success');
    }

    // SonuÃ§larÄ± gÃ¶sterme fonksiyonu
    function displayResults() {
      const matchedCount = analysisResults.filter(r => r.matched).length;
      const validDataCount = analysisResults.filter(r => r.startPrice !== null && r.endPrice !== null).length;
      
      document.getElementById('results-summary').innerHTML = `
        <p><strong>ğŸ“Š Toplam Analiz Edilen:</strong> ${analysisResults.length} hisse</p>
        <p><strong>âœ… EÅŸleÅŸen Hisseler:</strong> ${matchedCount} adet</p>
        <p><strong>ğŸ“ˆ GeÃ§erli Veri:</strong> ${validDataCount} adet</p>
        <p><strong>ğŸ¯ EÅŸleÅŸme OranÄ±:</strong> ${validDataCount > 0 ? ((matchedCount / validDataCount) * 100).toFixed(1) : 0}%</p>
      `;
      
      updateTable();
    }

    // Tablo gÃ¼ncelleme fonksiyonu
    function updateTable() {
      let filteredResults = [...analysisResults];
      
      // Filtreleme
      if (showOnlyMatched) {
        filteredResults = filteredResults.filter(r => r.matched);
      }
      
      // SÄ±ralama
      if (currentSortField) {
        filteredResults.sort((a, b) => {
          let aVal = a[currentSortField];
          let bVal = b[currentSortField];
          
          if (currentSortField === 'symbol') {
            aVal = aVal || '';
            bVal = bVal || '';
          } else if (typeof aVal === 'number' && typeof bVal === 'number') {
            // SayÄ±sal sÄ±ralama
          } else {
            aVal = aVal || 0;
            bVal = bVal || 0;
          }
          
          if (currentSortDirection === 'asc') {
            return aVal > bVal ? 1 : -1;
          } else {
            return aVal < bVal ? 1 : -1;
          }
        });
      }
      
      const tbody = document.getElementById('results-tbody');
      tbody.innerHTML = '';
      
      filteredResults.forEach(result => {
        const row = document.createElement('tr');
        
        const changeColor = result.change === null ? '#6b7280' : 
                           result.change >= 0 ? '#10b981' : '#ef4444';
        
        const changeText = result.change === null ? '-' : 
                          `${result.change >= 0 ? '+' : ''}${result.change}%`;
        
        row.innerHTML = `
          <td><strong>${result.symbol}</strong></td>
          <td>${result.startPrice !== null ? result.startPrice.toFixed(2) + ' â‚º' : '-'}</td>
          <td>${result.endPrice !== null ? result.endPrice.toFixed(2) + ' â‚º' : '-'}</td>
          <td style="color: ${changeColor}; font-weight: 600;">${changeText}</td>
          <td>${result.status}</td>
          <td>
            <button class="button outline" style="font-size: 0.8em; padding: 4px 8px;" 
                    onclick="analyzeIndividualStock('${result.symbol}.IS')">
              ğŸ“Š Detay
            </button>
          </td>
        `;
        
        if (result.matched) {
          row.style.backgroundColor = '#f0fdf4';
        }
        
        tbody.appendChild(row);
      });
    }

    // Bireysel hisse analizi
    function analyzeIndividualStock(symbol) {
      document.getElementById('stock-symbol-input').value = symbol;
      document.getElementById('btn-fetch-data').click();
    }

    // SÄ±ralama fonksiyonlarÄ±
    function sortBy(field) {
      if (currentSortField === field) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        currentSortField = field;
        currentSortDirection = 'asc';
      }
      updateTable();
    }

    // Filtreleme fonksiyonu
    function toggleFilter() {
      showOnlyMatched = !showOnlyMatched;
      const btn = document.getElementById('btn-filter-matched');
      btn.textContent = showOnlyMatched ? 'TÃ¼mÃ¼nÃ¼ GÃ¶ster' : 'Sadece EÅŸleÅŸenleri GÃ¶ster';
      btn.className = showOnlyMatched ? 'button success' : 'button outline';
      updateTable();
    }

    // SonuÃ§larÄ± dÄ±ÅŸa aktarma
    function exportResults() {
      const csvContent = [
        ['Hisse', 'BaÅŸlangÄ±Ã§ FiyatÄ±', 'BitiÅŸ FiyatÄ±', 'DeÄŸiÅŸim (%)', 'Durum'],
        ...analysisResults.map(r => [
          r.symbol,
          r.startPrice || '-',
          r.endPrice || '-',
          r.change || '-',
          r.status.replace(/[ğŸ“ŠğŸ“ˆğŸ“‰âœ…âŒ]/g, '').trim()
        ])
      ].map(row => row.join(',')).join('\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `hisse_analizi_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
      
      showNotification('ğŸ“Š SonuÃ§lar CSV olarak indirildi', 'success');
    }

    // Event listener'larÄ± ekle
    document.addEventListener('DOMContentLoaded', function() {
      // BugÃ¼nÃ¼n tarihini varsayÄ±lan olarak ayarla
      const today = new Date();
      const oneMonthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
      
      document.getElementById('start-date').value = oneMonthAgo.toISOString().split('T')[0];
      document.getElementById('end-date').value = today.toISOString().split('T')[0];
      
      // Button event listeners
      document.getElementById('btn-analyze-stocks').addEventListener('click', analyzeStocks);
      document.getElementById('btn-export-results').addEventListener('click', exportResults);
      
      // SÄ±ralama butonlarÄ±
      document.getElementById('btn-sort-symbol').addEventListener('click', () => sortBy('symbol'));
      document.getElementById('btn-sort-price').addEventListener('click', () => sortBy('startPrice'));
      document.getElementById('btn-sort-change').addEventListener('click', () => sortBy('change'));
      document.getElementById('btn-filter-matched').addEventListener('click', toggleFilter);
    });

    // Service Worker Registration ve PWA Ã¶zellikleri
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          // Service Worker'Ä± inline olarak kaydet
          const swCode = `
            const CACHE_NAME = 'borsa-analiz-v1';
            const urlsToCache = [
              './',
              'https://cdn.jsdelivr.net/npm/chart.js',
              'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js',
              'https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js',
              'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js'
            ];
            
            self.addEventListener('install', event => {
              event.waitUntil(
                caches.open(CACHE_NAME)
                  .then(cache => cache.addAll(urlsToCache))
              );
            });
            
            self.addEventListener('fetch', event => {
              event.respondWith(
                caches.match(event.request)
                  .then(response => {
                    if (response) {
                      return response;
                    }
                    return fetch(event.request);
                  }
                )
              );
            });
            
            self.addEventListener('activate', event => {
              event.waitUntil(
                caches.keys().then(cacheNames => {
                  return Promise.all(
                    cacheNames.map(cacheName => {
                      if (cacheName !== CACHE_NAME) {
                        return caches.delete(cacheName);
                      }
                    })
                  );
                })
              );
            });
          `;
          
          const blob = new Blob([swCode], { type: 'application/javascript' });
          const swUrl = URL.createObjectURL(blob);
          
          const registration = await navigator.serviceWorker.register(swUrl);
          console.log('âœ… Service Worker kayÄ±tlÄ±:', registration);
          
          // Blob URL'yi temizle
          URL.revokeObjectURL(swUrl);
          
        } catch (error) {
          console.log('âŒ Service Worker kaydÄ± baÅŸarÄ±sÄ±z:', error);
        }
      });
    }
    
    // PWA Install Prompt
    let deferredPrompt;
    let installButton;
    
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      // Install butonu oluÅŸtur
      if (!installButton) {
        installButton = document.createElement('button');
        installButton.innerHTML = 'ğŸ“± UygulamayÄ± YÃ¼kle';
        installButton.className = 'button default';
        installButton.style.cssText = `
          position: fixed;
          bottom: 20px;
          right: 20px;
          z-index: 1000;
          box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
          animation: pulse 2s infinite;
        `;
        
        // Pulse animasyonu ekle
        if (!document.querySelector('#pulse-animation')) {
          const style = document.createElement('style');
          style.id = 'pulse-animation';
          style.textContent = `
            @keyframes pulse {
              0% { transform: scale(1); }
              50% { transform: scale(1.05); }
              100% { transform: scale(1); }
            }
          `;
          document.head.appendChild(style);
        }
        
        installButton.addEventListener('click', async () => {
          if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
              console.log('âœ… KullanÄ±cÄ± uygulamayÄ± yÃ¼kledi');
              showNotification('ğŸ‰ Uygulama baÅŸarÄ±yla yÃ¼klendi!', 'success');
            } else {
              console.log('âŒ KullanÄ±cÄ± uygulamayÄ± yÃ¼klemedi');
            }
            
            deferredPrompt = null;
            installButton.remove();
            installButton = null;
          }
        });
        
        document.body.appendChild(installButton);
        
        // 3 saniye sonra bildirim gÃ¶ster
        setTimeout(() => {
          showNotification('ğŸ’¡ Bu uygulamayÄ± telefonunuza yÃ¼kleyebilirsiniz!', 'info', 5000);
        }, 3000);
      }
    });
    
    // Uygulama yÃ¼klendiÄŸinde
    window.addEventListener('appinstalled', () => {
      console.log('âœ… PWA yÃ¼klendi');
      showNotification('ğŸ‰ Borsa Analiz uygulamasÄ± baÅŸarÄ±yla yÃ¼klendi!', 'success');
      
      if (installButton) {
        installButton.remove();
        installButton = null;
      }
    });
    
    // Bildirim gÃ¶sterme fonksiyonu
    function showNotification(message, type = 'info', duration = 3000) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1001;
        padding: 12px 16px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        max-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideInRight 0.3s ease-out;
      `;
      
      // Tip'e gÃ¶re renk
      const colors = {
        success: '#10b981',
        error: '#ef4444',
        warning: '#f59e0b',
        info: '#3b82f6'
      };
      
      notification.style.backgroundColor = colors[type] || colors.info;
      notification.textContent = message;
      
      // Slide animasyonu
      if (!document.querySelector('#slide-animation')) {
        const style = document.createElement('style');
        style.id = 'slide-animation';
        style.textContent = `
          @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
          }
          @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
          }
        `;
        document.head.appendChild(style);
      }
      
      document.body.appendChild(notification);
      
      // Otomatik kaldÄ±rma
      setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease-in';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.remove();
          }
        }, 300);
      }, duration);
    }
    
    // Ã‡evrimdÄ±ÅŸÄ±/Ã§evrimiÃ§i durumu
    function updateOnlineStatus() {
      const status = navigator.onLine ? 'Ã§evrimiÃ§i' : 'Ã§evrimdÄ±ÅŸÄ±';
      const type = navigator.onLine ? 'success' : 'warning';
      const icon = navigator.onLine ? 'ğŸŒ' : 'ğŸ“´';
      
      showNotification(`${icon} BaÄŸlantÄ± durumu: ${status}`, type, 2000);
    }
    
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    
    // Sayfa yÃ¼klendiÄŸinde hoÅŸ geldin mesajÄ±
    window.addEventListener('load', () => {
      setTimeout(() => {
        showNotification('ğŸš€ AI Destekli Borsa Analiz Platformu\'na hoÅŸ geldiniz!', 'info', 4000);
      }, 1000);
    });
    
    // PWA Ã¶zelliklerini kontrol et ve gÃ¶ster
    function checkPWAFeatures() {
      const features = {
        'Service Worker': 'serviceWorker' in navigator,
        'Cache API': 'caches' in window,
        'Push Notifications': 'PushManager' in window,
        'Background Sync': 'serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype,
        'Install Prompt': 'BeforeInstallPromptEvent' in window
      };
      
      console.log('ğŸ” PWA Ã–zellik DesteÄŸi:', features);
      return features;
    }
    
    // Debug iÃ§in PWA Ã¶zelliklerini kontrol et
    checkPWAFeatures();
    
  </script>
</body>
</html>
